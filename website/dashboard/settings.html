<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - TrueVault VPN</title>
    <style>
        :root {
            --primary: #00d9ff;
            --secondary: #00ff88;
            --bg: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --text: #ffffff;
            --text-muted: #888888;
            --success: #00ff88;
            --error: #ff6464;
            --card-radius: 14px;
            --btn-radius: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg), var(--bg-secondary));
            color: var(--text);
            min-height: 100vh;
        }
        a { color: var(--primary); text-decoration: none; }
        
        .app { display: flex; min-height: 100vh; }
        .sidebar {
            width: 240px;
            background: rgba(255,255,255,0.02);
            border-right: 1px solid rgba(255,255,255,0.08);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
        }
        .main { flex: 1; margin-left: 240px; padding: 25px; max-width: 800px; }
        .logo { padding: 0 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); margin-bottom: 20px; }
        .logo h1 {
            font-size: 1.2rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .logo small { color: var(--text-muted); font-size: 0.75rem; }
        .nav-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 20px; color: var(--text-muted);
            text-decoration: none; transition: 0.2s;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(0,217,255,0.1); color: var(--primary);
        }
        .nav-item.active { border-left: 3px solid var(--primary); }
        
        .card {
            background: rgba(255,255,255,0.04);
            border-radius: var(--card-radius);
            padding: 25px; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .card-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        
        .btn {
            padding: 10px 18px; border: none;
            border-radius: var(--btn-radius);
            font-size: 0.9rem; font-weight: 600;
            cursor: pointer; transition: 0.2s;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: var(--bg);
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-secondary {
            background: rgba(255,255,255,0.08);
            color: var(--text);
            border: 1px solid rgba(255,255,255,0.15);
        }
        .btn-danger { background: rgba(255,100,100,0.15); color: var(--error); }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: var(--text); font-weight: 500; }
        .form-help { font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; }
        .form-input {
            width: 100%; padding: 12px 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--btn-radius);
            color: var(--text); font-size: 0.95rem;
        }
        .form-input:focus { outline: none; border-color: var(--primary); }
        .form-input:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .alert {
            padding: 12px 15px; border-radius: var(--btn-radius);
            margin-bottom: 15px; font-size: 0.9rem;
        }
        .alert-success { background: rgba(0,255,136,0.15); color: var(--success); }
        .alert-error { background: rgba(255,100,100,0.15); color: var(--error); }
        
        .divider {
            border: none;
            border-top: 1px solid rgba(255,255,255,0.08);
            margin: 25px 0;
        }
        
        .danger-zone {
            border-color: rgba(255,100,100,0.3);
            background: rgba(255,100,100,0.05);
        }
        
        .hidden { display: none !important; }
        .text-muted { color: var(--text-muted); }
        
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { margin-left: 0; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="logo">
                <h1>üîê TrueVault VPN</h1>
                <small>Secure ‚Ä¢ Private ‚Ä¢ Fast</small>
            </div>
            <nav>
                <a class="nav-item" href="/dashboard/">
                    <span>üè†</span> Dashboard
                </a>
                <a class="nav-item" href="/dashboard/devices.html">
                    <span>üì±</span> My Devices
                </a>
                <a class="nav-item" href="/dashboard/billing.html">
                    <span>üí≥</span> Billing
                </a>
                <a class="nav-item active" href="/dashboard/settings.html">
                    <span>‚öôÔ∏è</span> Settings
                </a>
            </nav>
            <div style="padding:20px;margin-top:auto;border-top:1px solid rgba(255,255,255,0.08)">
                <button onclick="logout()" class="btn btn-secondary" style="width:100%">üö™ Logout</button>
            </div>
        </aside>

        <main class="main">
            <h1 style="margin-bottom:25px">‚öôÔ∏è Account Settings</h1>
            
            <div id="alert-container"></div>
            
            <!-- Profile Settings -->
            <div class="card">
                <h2 class="card-title">üë§ Profile Information</h2>
                <form id="profile-form" onsubmit="updateProfile(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">First Name</label>
                            <input type="text" name="first_name" class="form-input" id="first_name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name</label>
                            <input type="text" name="last_name" class="form-input" id="last_name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" name="email" class="form-input" id="email" disabled>
                        <p class="form-help">Contact support to change your email address</p>
                    </div>
                    <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                </form>
            </div>
            
            <!-- Password Settings -->
            <div class="card">
                <h2 class="card-title">üîí Change Password</h2>
                <form id="password-form" onsubmit="changePassword(event)">
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" name="current_password" class="form-input" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <input type="password" name="new_password" class="form-input" required minlength="8">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" name="confirm_password" class="form-input" required minlength="8">
                        </div>
                    </div>
                    <p class="form-help" style="margin-bottom:15px">Password must be at least 8 characters long</p>
                    <button type="submit" class="btn btn-secondary">üîë Update Password</button>
                </form>
            </div>
            
            <!-- VPN Preferences -->
            <div class="card">
                <h2 class="card-title">üåê VPN Preferences</h2>
                <form id="preferences-form" onsubmit="updatePreferences(event)">
                    <div class="form-group">
                        <label class="form-label">Preferred Server</label>
                        <select name="preferred_server" class="form-input" id="preferred_server">
                            <option value="">Auto (Best Available)</option>
                        </select>
                        <p class="form-help">Default server when connecting</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">DNS Servers</label>
                        <select name="dns_preference" class="form-input" id="dns_preference">
                            <option value="truevault">TrueVault DNS (Recommended)</option>
                            <option value="cloudflare">Cloudflare (1.1.1.1)</option>
                            <option value="google">Google (8.8.8.8)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">üíæ Save Preferences</button>
                </form>
            </div>
            
            <!-- Danger Zone -->
            <div class="card danger-zone">
                <h2 class="card-title" style="color:var(--error)">‚ö†Ô∏è Danger Zone</h2>
                <p class="text-muted" style="margin-bottom:15px">
                    These actions are permanent and cannot be undone.
                </p>
                <button class="btn btn-danger" onclick="deleteAccount()">
                    üóëÔ∏è Delete Account
                </button>
            </div>
        </main>
    </div>

    <script>
        const API = '/api';
        let authToken = localStorage.getItem('auth_token');
        let userData = null;

        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) {
                window.location.href = '/login.html';
                return;
            }
            loadSettings();
        });

        function logout() {
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
        }

        async function api(endpoint, options = {}) {
            const res = await fetch(endpoint, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    ...options.headers
                }
            });
            if (res.status === 401) { logout(); return null; }
            return await res.json();
        }

        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
            window.scrollTo(0, 0);
        }

        async function loadSettings() {
            const [profileRes, serversRes] = await Promise.all([
                api(`${API}/user/profile.php`),
                api(`${API}/servers/list.php`)
            ]);
            
            if (profileRes && profileRes.success) {
                userData = profileRes.user;
                document.getElementById('first_name').value = userData.first_name || '';
                document.getElementById('last_name').value = userData.last_name || '';
                document.getElementById('email').value = userData.email || '';
            }
            
            if (serversRes && serversRes.success) {
                const select = document.getElementById('preferred_server');
                serversRes.servers.forEach(srv => {
                    const opt = document.createElement('option');
                    opt.value = srv.id;
                    opt.textContent = `${srv.display_name} (${srv.location})`;
                    select.appendChild(opt);
                });
            }
        }

        async function updateProfile(e) {
            e.preventDefault();
            const form = e.target;
            
            const res = await api(`${API}/user/profile.php`, {
                method: 'PUT',
                body: JSON.stringify({
                    first_name: form.first_name.value,
                    last_name: form.last_name.value
                })
            });
            
            if (res && res.success) {
                showAlert('Profile updated successfully!');
            } else {
                showAlert(res?.error || 'Failed to update profile', 'error');
            }
        }

        async function changePassword(e) {
            e.preventDefault();
            const form = e.target;
            
            if (form.new_password.value !== form.confirm_password.value) {
                showAlert('Passwords do not match', 'error');
                return;
            }
            
            const res = await api(`${API}/user/password.php`, {
                method: 'POST',
                body: JSON.stringify({
                    current_password: form.current_password.value,
                    new_password: form.new_password.value
                })
            });
            
            if (res && res.success) {
                showAlert('Password changed successfully!');
                form.reset();
            } else {
                showAlert(res?.error || 'Failed to change password', 'error');
            }
        }

        async function updatePreferences(e) {
            e.preventDefault();
            const form = e.target;
            
            // Save to localStorage for now
            localStorage.setItem('preferred_server', form.preferred_server.value);
            localStorage.setItem('dns_preference', form.dns_preference.value);
            
            showAlert('Preferences saved!');
        }

        async function deleteAccount() {
            const confirmed = prompt('This will permanently delete your account and all data. Type "DELETE" to confirm:');
            
            if (confirmed !== 'DELETE') {
                return;
            }
            
            const res = await api(`${API}/user/delete.php`, {
                method: 'DELETE'
            });
            
            if (res && res.success) {
                alert('Account deleted. You will be logged out.');
                logout();
            } else {
                showAlert(res?.error || 'Failed to delete account', 'error');
            }
        }
    </script>
</body>
</html>
