<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Devices - TrueVault VPN</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00d9ff;
            --secondary: #00ff88;
            --accent: #ff6b6b;
            --bg: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --text: #ffffff;
            --text-muted: #888888;
            --success: #00ff88;
            --error: #ff6464;
            --card-radius: 14px;
            --btn-radius: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg), var(--bg-secondary));
            color: var(--text);
            min-height: 100vh;
        }
        a { color: var(--primary); text-decoration: none; }
        
        .app { display: flex; min-height: 100vh; }
        .sidebar {
            width: 240px;
            background: rgba(255,255,255,0.02);
            border-right: 1px solid rgba(255,255,255,0.08);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
        }
        .main { flex: 1; margin-left: 240px; padding: 25px; }
        .logo { padding: 0 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); margin-bottom: 20px; }
        .logo h1 {
            font-size: 1.2rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .logo small { color: var(--text-muted); font-size: 0.75rem; }
        .nav-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 20px; color: var(--text-muted);
            text-decoration: none; transition: 0.2s;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(0,217,255,0.1); color: var(--primary);
        }
        .nav-item.active { border-left: 3px solid var(--primary); }
        
        .card {
            background: rgba(255,255,255,0.04);
            border-radius: var(--card-radius);
            padding: 20px; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .card-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 20px;
        }
        .card-title { font-size: 1.2rem; font-weight: 600; }
        
        .btn {
            padding: 10px 18px; border: none;
            border-radius: var(--btn-radius);
            font-size: 0.9rem; font-weight: 600;
            cursor: pointer; transition: 0.2s;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: var(--bg);
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-secondary {
            background: rgba(255,255,255,0.08);
            color: var(--text);
            border: 1px solid rgba(255,255,255,0.15);
        }
        .btn-danger { background: rgba(255,100,100,0.15); color: var(--error); }
        .btn-small { padding: 6px 12px; font-size: 0.8rem; }
        
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .device-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: var(--card-radius);
            padding: 20px;
        }
        .device-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .device-icon { font-size: 2.5rem; }
        .device-name { font-size: 1.1rem; font-weight: 600; }
        .device-ip { font-family: monospace; color: var(--primary); font-size: 0.9rem; }
        .device-meta { margin-top: 5px; font-size: 0.8rem; color: var(--text-muted); }
        .device-status {
            display: inline-block; padding: 4px 12px;
            border-radius: 20px; font-size: 0.75rem; font-weight: 600;
        }
        .device-status.online { background: rgba(0,255,136,0.15); color: var(--success); }
        .device-status.offline { background: rgba(255,255,255,0.1); color: var(--text-muted); }
        .device-actions { display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap; }
        
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 6px; color: var(--text-muted); font-size: 0.9rem; }
        .form-input {
            width: 100%; padding: 12px 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--btn-radius);
            color: var(--text); font-size: 0.95rem;
        }
        .form-input:focus { outline: none; border-color: var(--primary); }
        select.form-input { cursor: pointer; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--bg-secondary);
            border-radius: var(--card-radius);
            padding: 25px; max-width: 500px; width: 90%;
            max-height: 90vh; overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.2rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }
        
        .qr-container { text-align: center; padding: 20px; }
        .qr-code {
            background: #fff; padding: 15px;
            border-radius: 10px; display: inline-block; margin-bottom: 15px;
        }
        .qr-code img { display: block; }
        
        .config-box {
            background: rgba(0,0,0,0.3);
            border-radius: var(--btn-radius);
            padding: 15px;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .empty-state {
            text-align: center; padding: 50px 20px;
        }
        .empty-icon { font-size: 4rem; margin-bottom: 15px; }
        
        .alert {
            padding: 12px 15px; border-radius: var(--btn-radius);
            margin-bottom: 15px; font-size: 0.9rem;
        }
        .alert-success { background: rgba(0,255,136,0.15); color: var(--success); }
        .alert-error { background: rgba(255,100,100,0.15); color: var(--error); }
        
        .usage-bar { margin-top: 15px; }
        .usage-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; }
        .usage-track { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .usage-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); }
        
        .hidden { display: none !important; }
        .text-muted { color: var(--text-muted); }
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { margin-left: 0; }
        }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="logo">
                <h1>üîê TrueVault VPN</h1>
                <small>Secure ‚Ä¢ Private ‚Ä¢ Fast</small>
            </div>
            <nav>
                <a class="nav-item" href="/dashboard/">
                    <span>üè†</span> Dashboard
                </a>
                <a class="nav-item active" href="/dashboard/devices.html">
                    <span>üì±</span> My Devices
                </a>
                <a class="nav-item" href="/dashboard/billing.html">
                    <span>üí≥</span> Billing
                </a>
                <a class="nav-item" href="/dashboard/settings.html">
                    <span>‚öôÔ∏è</span> Settings
                </a>
            </nav>
            <div style="padding:20px;margin-top:auto;border-top:1px solid rgba(255,255,255,0.08)">
                <button onclick="logout()" class="btn btn-secondary" style="width:100%">üö™ Logout</button>
            </div>
        </aside>

        <main class="main">
            <div id="alert-container"></div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üì± My Devices</span>
                    <button class="btn btn-primary" onclick="showAddDeviceModal()">+ Add Device</button>
                </div>
                
                <!-- Usage Bar -->
                <div class="usage-bar">
                    <div class="usage-label">
                        <span>Device Usage</span>
                        <span id="device-usage">0 / 0 devices</span>
                    </div>
                    <div class="usage-track">
                        <div class="usage-fill" id="usage-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div id="devices-container">
                <div class="device-grid" id="devices-grid"></div>
                
                <div id="empty-state" class="empty-state hidden">
                    <div class="empty-icon">üì±</div>
                    <h3>No Devices Yet</h3>
                    <p class="text-muted">Add your first device to start using the VPN</p>
                    <button class="btn btn-primary mt-20" onclick="showAddDeviceModal()">+ Add Your First Device</button>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-container"></div>

    <script>
        const API = '/api';
        let authToken = localStorage.getItem('auth_token');
        let devices = [];
        let maxDevices = 3;

        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) {
                window.location.href = '/login.html';
                return;
            }
            loadDevices();
            
            // Check for config parameter
            const params = new URLSearchParams(window.location.search);
            if (params.get('config')) {
                setTimeout(() => showConfigModal(params.get('config')), 500);
            }
        });

        function logout() {
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
        }

        async function api(endpoint, options = {}) {
            const res = await fetch(endpoint, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    ...options.headers
                }
            });
            if (res.status === 401) { logout(); return null; }
            return await res.json();
        }

        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        async function loadDevices() {
            const [devicesRes, profileRes] = await Promise.all([
                api(`${API}/devices/list.php`),
                api(`${API}/user/profile.php`)
            ]);
            
            if (profileRes && profileRes.success) {
                maxDevices = profileRes.user.max_devices || 3;
            }
            
            if (devicesRes && devicesRes.success) {
                devices = devicesRes.devices;
                renderDevices();
            }
        }

        function renderDevices() {
            const grid = document.getElementById('devices-grid');
            const empty = document.getElementById('empty-state');
            
            // Update usage
            document.getElementById('device-usage').textContent = `${devices.length} / ${maxDevices} devices`;
            document.getElementById('usage-fill').style.width = `${(devices.length / maxDevices) * 100}%`;
            
            if (devices.length === 0) {
                grid.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }
            
            grid.classList.remove('hidden');
            empty.classList.add('hidden');
            
            grid.innerHTML = devices.map(dev => `
                <div class="device-card">
                    <div class="device-header">
                        <span class="device-icon">${getDeviceIcon(dev.device_type)}</span>
                        <div style="flex:1">
                            <div class="device-name">${dev.device_name}</div>
                            <div class="device-ip">${dev.assigned_ip}</div>
                            <div class="device-meta">Created: ${new Date(dev.created_at).toLocaleDateString()}</div>
                        </div>
                        <span class="device-status ${dev.is_online ? 'online' : 'offline'}">
                            ${dev.is_online ? '‚óè Online' : '‚óã Offline'}
                        </span>
                    </div>
                    <div class="device-actions">
                        <button class="btn btn-small btn-primary" onclick="showConfigModal('${dev.device_id}')">
                            üì• Get Config
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="showQRModal('${dev.device_id}')">
                            üì± QR Code
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteDevice('${dev.device_id}')">
                            üóëÔ∏è Remove
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getDeviceIcon(type) {
            return { windows: 'üíª', mac: 'üñ•Ô∏è', linux: 'üêß', android: 'üì±', ios: 'üì±', router: 'üì°' }[type] || 'üìü';
        }

        function showModal(title, content) {
            document.getElementById('modal-container').innerHTML = `
                <div class="modal-overlay show" onclick="closeModal(event)">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <span class="modal-title">${title}</span>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        ${content}
                    </div>
                </div>
            `;
        }

        function closeModal(e) {
            if (!e || e.target.classList.contains('modal-overlay')) {
                document.getElementById('modal-container').innerHTML = '';
            }
        }

        function showAddDeviceModal() {
            if (devices.length >= maxDevices) {
                showAlert(`Device limit reached (${maxDevices}). Upgrade your plan for more devices.`, 'error');
                return;
            }
            
            showModal('Add New Device', `
                <form onsubmit="addDevice(event)">
                    <div class="form-group">
                        <label class="form-label">Device Name</label>
                        <input type="text" name="device_name" class="form-input" 
                               placeholder="e.g., My iPhone, Work Laptop" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Device Type</label>
                        <select name="device_type" class="form-input">
                            <option value="windows">üíª Windows</option>
                            <option value="mac">üñ•Ô∏è Mac</option>
                            <option value="linux">üêß Linux</option>
                            <option value="android">üì± Android</option>
                            <option value="ios">üì± iOS / iPhone</option>
                            <option value="router">üì° Router</option>
                            <option value="other">üìü Other</option>
                        </select>
                    </div>
                    <p class="text-muted" style="font-size:0.85rem;margin-bottom:15px">
                        üîê Your private key will be generated securely in your browser and never sent to our servers.
                    </p>
                    <button type="submit" class="btn btn-primary" style="width:100%">
                        Create Device
                    </button>
                </form>
            `);
        }

        async function addDevice(e) {
            e.preventDefault();
            const form = e.target;
            const deviceName = form.device_name.value;
            const deviceType = form.device_type.value;
            
            // Generate keys in browser (using Web Crypto API simulation)
            // In production, use TweetNaCl.js for proper WireGuard keys
            const keyPair = await generateKeyPair();
            
            const res = await api(`${API}/devices/register.php`, {
                method: 'POST',
                body: JSON.stringify({
                    device_name: deviceName,
                    device_type: deviceType,
                    public_key: keyPair.publicKey
                })
            });
            
            if (res && res.success) {
                closeModal();
                showAlert('Device added successfully! Download your config to connect.');
                
                // Store private key temporarily for config download
                sessionStorage.setItem(`pk_${res.device.device_id}`, keyPair.privateKey);
                
                await loadDevices();
                
                // Show config modal
                setTimeout(() => showConfigModal(res.device.device_id), 500);
            } else {
                showAlert(res?.error || 'Failed to add device', 'error');
            }
        }

        // Simple key generation (replace with TweetNaCl.js in production)
        async function generateKeyPair() {
            // This is a placeholder - in production use tweetnacl-js
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            const privateKey = btoa(String.fromCharCode(...array));
            
            // In real implementation, derive public key from private
            const pubArray = new Uint8Array(32);
            crypto.getRandomValues(pubArray);
            const publicKey = btoa(String.fromCharCode(...pubArray));
            
            return { privateKey, publicKey };
        }

        async function showConfigModal(deviceId) {
            const res = await api(`${API}/devices/config.php?device_id=${deviceId}`);
            
            if (!res || !res.success) {
                showAlert('Failed to get config', 'error');
                return;
            }
            
            const config = res.config;
            const privateKey = sessionStorage.getItem(`pk_${deviceId}`) || '[Your Private Key]';
            
            // Build config file content
            const configContent = `[Interface]
PrivateKey = ${privateKey}
Address = ${config.client_ip}/32
DNS = ${config.dns}

[Peer]
PublicKey = ${config.server_public_key}
Endpoint = ${config.endpoint}
AllowedIPs = ${config.allowed_ips}
PersistentKeepalive = 25`;

            showModal('üì• WireGuard Configuration', `
                <div class="text-center" style="margin-bottom:15px">
                    <p>Server: <strong>${config.server_name}</strong></p>
                    <p class="text-muted">${config.server_location}</p>
                </div>
                <div class="config-box">${configContent}</div>
                <div style="display:flex;gap:10px">
                    <button class="btn btn-primary" style="flex:1" onclick="downloadConfig('${deviceId}', \`${configContent.replace(/`/g, '\\`')}\`)">
                        üì• Download .conf
                    </button>
                    <button class="btn btn-secondary" style="flex:1" onclick="copyConfig(\`${configContent.replace(/`/g, '\\`')}\`)">
                        üìã Copy
                    </button>
                </div>
                <p class="text-muted text-center mt-20" style="font-size:0.8rem">
                    Import this file into the WireGuard app on your device
                </p>
            `);
        }

        async function showQRModal(deviceId) {
            const res = await api(`${API}/devices/qr.php?device_id=${deviceId}`);
            
            if (!res || !res.success) {
                showAlert('Failed to generate QR code', 'error');
                return;
            }
            
            showModal('üì± Scan QR Code', `
                <div class="qr-container">
                    <div class="qr-code">
                        <img src="${res.qr_code}" alt="QR Code" style="width:200px;height:200px">
                    </div>
                    <p class="text-muted">Scan with WireGuard app on your mobile device</p>
                </div>
            `);
        }

        function downloadConfig(deviceId, content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `truevault-${deviceId}.conf`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyConfig(content) {
            navigator.clipboard.writeText(content);
            showAlert('Configuration copied to clipboard!');
        }

        async function deleteDevice(deviceId) {
            if (!confirm('Remove this device? This cannot be undone.')) return;
            
            const res = await api(`${API}/devices/remove.php`, {
                method: 'POST',
                body: JSON.stringify({ device_id: deviceId })
            });
            
            if (res && res.success) {
                showAlert('Device removed');
                sessionStorage.removeItem(`pk_${deviceId}`);
                loadDevices();
            } else {
                showAlert(res?.error || 'Failed to remove device', 'error');
            }
        }
    </script>
</body>
</html>
