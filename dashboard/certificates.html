<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificates - TrueVault VPN</title>
    <link rel="stylesheet" href="assets/css/dashboard.css">
</head>
<body>
    <div id="app">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo"><span class="logo-icon">üîê</span><span class="logo-text">TrueVault</span></div>
            </div>
            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item"><span class="nav-icon">üè†</span><span class="nav-text">Dashboard</span></a>
                <a href="connect.html" class="nav-item"><span class="nav-icon">üîå</span><span class="nav-text">Connect</span></a>
                <a href="servers.html" class="nav-item"><span class="nav-icon">üñ•Ô∏è</span><span class="nav-text">Servers</span></a>
                <a href="devices.html" class="nav-item"><span class="nav-icon">üì±</span><span class="nav-text">Devices</span></a>
                <a href="cameras.html" class="nav-item"><span class="nav-icon">üì∑</span><span class="nav-text">Cameras</span></a>
                <a href="scanner.html" class="nav-item"><span class="nav-icon">üîç</span><span class="nav-text">Scanner</span></a>
                <a href="certificates.html" class="nav-item active"><span class="nav-icon">üìú</span><span class="nav-text">Certificates</span></a>
                <a href="settings.html" class="nav-item"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-text">Settings</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <span class="user-avatar" id="userAvatar">U</span>
                    <div class="user-details">
                        <span class="user-name" id="userName">Loading...</span>
                        <span class="user-plan" id="userPlan">Free</span>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                <h1 class="page-title">My Certificates</h1>
                <button class="btn btn-primary" onclick="generateCertificate()">+ Generate New</button>
            </header>

            <div class="content-area">
                <!-- Certificate Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìú</div>
                        <div class="stat-info">
                            <span class="stat-value" id="totalCerts">0</span>
                            <span class="stat-label">Total Certificates</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-info">
                            <span class="stat-value" id="activeCerts">0</span>
                            <span class="stat-label">Active</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è∞</div>
                        <div class="stat-info">
                            <span class="stat-value" id="expiringCerts">0</span>
                            <span class="stat-label">Expiring Soon</span>
                        </div>
                    </div>
                </div>

                <!-- Certificate Info -->
                <div class="card highlight-card">
                    <div class="cert-hero">
                        <div class="cert-icon">üîê</div>
                        <div class="cert-info">
                            <h2>Your Personal Certificate Authority</h2>
                            <p>Every TrueVault subscriber receives their own cryptographic identity infrastructure. Your certificates enable secure device authentication, end-to-end encryption, and mesh network connections.</p>
                        </div>
                    </div>
                </div>

                <!-- Certificate Types -->
                <div class="card">
                    <div class="card-header">
                        <h3>Certificate Types</h3>
                    </div>
                    <div class="cert-types-grid">
                        <div class="cert-type">
                            <div class="cert-type-icon">üîë</div>
                            <h4>Root Certificate</h4>
                            <p>Your unique digital identity anchor. Like a passport for the internet.</p>
                            <span class="cert-status active">Active</span>
                        </div>
                        <div class="cert-type">
                            <div class="cert-type-icon">üì±</div>
                            <h4>Device Certificates</h4>
                            <p>Secure every phone, laptop, tablet, and smart device you own.</p>
                            <span class="cert-count" id="deviceCertCount">0 issued</span>
                        </div>
                        <div class="cert-type">
                            <div class="cert-type-icon">üåç</div>
                            <h4>Regional Identity</h4>
                            <p>Persistent credentials for USA, Canada, UK, EU, and 50+ regions.</p>
                            <span class="cert-count" id="regionCertCount">0 active</span>
                        </div>
                        <div class="cert-type">
                            <div class="cert-type-icon">üîó</div>
                            <h4>Mesh Trust</h4>
                            <p>Securely connect with family and team members' networks.</p>
                            <span class="cert-count" id="meshCertCount">0 connections</span>
                        </div>
                    </div>
                </div>

                <!-- My Certificates List -->
                <div class="card">
                    <div class="card-header">
                        <h3>My Certificates</h3>
                    </div>
                    <div class="cert-list" id="certList">
                        <div class="empty-state">
                            <span class="empty-icon">üìú</span>
                            <p>No certificates generated yet</p>
                            <button class="btn btn-primary" onclick="generateCertificate()">Generate Your First Certificate</button>
                        </div>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="card">
                    <div class="card-header">
                        <h3>Export & Backup</h3>
                    </div>
                    <div class="export-options">
                        <button class="export-btn" onclick="exportCerts('pem')">
                            <span>üìÑ</span>
                            <span>Export as PEM</span>
                        </button>
                        <button class="export-btn" onclick="exportCerts('p12')">
                            <span>üîí</span>
                            <span>Export as PKCS#12</span>
                        </button>
                        <button class="export-btn" onclick="exportCerts('yubikey')">
                            <span>üîë</span>
                            <span>Export to YubiKey</span>
                        </button>
                        <button class="export-btn" onclick="backupCerts()">
                            <span>‚òÅÔ∏è</span>
                            <span>Cloud Backup</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = '/api';
        let token = localStorage.getItem('truevault_token');
        let user = JSON.parse(localStorage.getItem('truevault_user') || '{}');
        let certificates = [];

        if (!token) window.location.href = '/index.html#login';

        document.getElementById('userName').textContent = user.first_name || 'User';
        document.getElementById('userPlan').textContent = user.is_vip ? 'VIP' : (user.plan || 'Basic');
        document.getElementById('userAvatar').textContent = (user.first_name || 'U')[0].toUpperCase();

        async function loadCertificates() {
            try {
                const res = await fetch(`${API_BASE}/certificates/list.php`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    certificates = data.data || [];
                    renderCertificates();
                }
            } catch (err) {
                console.error('Failed to load certificates');
            }
        }

        function renderCertificates() {
            document.getElementById('totalCerts').textContent = certificates.length;
            document.getElementById('activeCerts').textContent = certificates.filter(c => c.status === 'active').length;
            document.getElementById('expiringCerts').textContent = certificates.filter(c => isExpiringSoon(c.expires_at)).length;

            const list = document.getElementById('certList');
            if (certificates.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <span class="empty-icon">üìú</span>
                        <p>No certificates generated yet</p>
                        <button class="btn btn-primary" onclick="generateCertificate()">Generate Your First Certificate</button>
                    </div>
                `;
                return;
            }

            list.innerHTML = certificates.map(c => `
                <div class="cert-item ${c.status}">
                    <div class="cert-item-icon">${getCertIcon(c.type)}</div>
                    <div class="cert-item-info">
                        <h4>${c.name}</h4>
                        <p>${c.type} certificate</p>
                        <span class="cert-date">Expires: ${new Date(c.expires_at).toLocaleDateString()}</span>
                    </div>
                    <div class="cert-item-status ${c.status}">${c.status}</div>
                    <div class="cert-item-actions">
                        <button class="btn btn-small" onclick="downloadCert(${c.id})">Download</button>
                        <button class="btn btn-small btn-danger" onclick="revokeCert(${c.id})">Revoke</button>
                    </div>
                </div>
            `).join('');
        }

        function getCertIcon(type) {
            const icons = { root: 'üîë', device: 'üì±', regional: 'üåç', mesh: 'üîó' };
            return icons[type] || 'üìú';
        }

        function isExpiringSoon(date) {
            const diff = new Date(date) - new Date();
            return diff > 0 && diff < 30 * 24 * 60 * 60 * 1000; // 30 days
        }

        async function generateCertificate() {
            const name = prompt('Certificate name (e.g., "My iPhone"):');
            if (!name) return;

            try {
                const res = await fetch(`${API_BASE}/certificates/generate.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ name, type: 'device' })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Certificate generated!', 'success');
                    loadCertificates();
                } else {
                    showToast(data.error || 'Failed to generate', 'error');
                }
            } catch (err) {
                showToast('Error generating certificate', 'error');
            }
        }

        function exportCerts(format) {
            showToast(`Exporting as ${format.toUpperCase()}...`, 'info');
        }

        function backupCerts() {
            showToast('Backing up certificates...', 'info');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
        function logout() { localStorage.clear(); window.location.href = '/index.html'; }

        loadCertificates();
    </script>

    <style>
        .highlight-card { background: linear-gradient(135deg, rgba(0,217,255,0.05), rgba(0,255,136,0.05)); border-color: rgba(0,217,255,0.2); }
        .cert-hero { display: flex; align-items: center; gap: 1.5rem; }
        .cert-icon { font-size: 4rem; }
        .cert-info h2 { margin-bottom: 0.5rem; }
        .cert-info p { color: #888; }
        .cert-types-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; }
        .cert-type { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 1.5rem; }
        .cert-type-icon { font-size: 2rem; margin-bottom: 1rem; }
        .cert-type h4 { margin-bottom: 0.5rem; }
        .cert-type p { color: #888; font-size: 0.9rem; margin-bottom: 1rem; }
        .cert-status { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; }
        .cert-status.active { background: rgba(0,255,136,0.2); color: #00ff88; }
        .cert-count { color: #00d9ff; font-size: 0.85rem; }
        .cert-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .cert-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; }
        .cert-item.active { border-left: 3px solid #00ff88; }
        .cert-item-icon { font-size: 1.5rem; }
        .cert-item-info { flex: 1; }
        .cert-item-info h4 { margin-bottom: 0.25rem; }
        .cert-item-info p { color: #888; font-size: 0.85rem; }
        .cert-date { font-size: 0.8rem; color: #666; }
        .cert-item-status { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; }
        .cert-item-status.active { background: rgba(0,255,136,0.2); color: #00ff88; }
        .cert-item-actions { display: flex; gap: 0.5rem; }
        .export-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
        .export-btn { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 1.5rem; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; cursor: pointer; transition: all 0.2s; }
        .export-btn:hover { background: rgba(0,217,255,0.1); border-color: #00d9ff; }
        .export-btn span:first-child { font-size: 1.5rem; }
        .empty-state { text-align: center; padding: 3rem; }
        .empty-icon { font-size: 4rem; display: block; margin-bottom: 1rem; }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; z-index: 1000; color: #fff; }
        .toast-success { background: #00c853; }
        .toast-error { background: #ff5252; }
        .toast-info { background: #00d9ff; color: #0f0f1a; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-primary { background: linear-gradient(90deg, #00d9ff, #00ff88); color: #0f0f1a; }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.85rem; background: rgba(255,255,255,0.1); color: #fff; }
        .btn-danger { background: rgba(255,80,80,0.2); color: #ff5050; }
    </style>
</body>
</html>
