<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - TrueVault VPN</title>
    <link rel="stylesheet" href="assets/css/dashboard.css">
</head>
<body>
    <div id="app">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo"><span class="logo-icon">üîê</span><span class="logo-text">TrueVault</span></div>
            </div>
            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item"><span class="nav-icon">üè†</span><span class="nav-text">Dashboard</span></a>
                <a href="connect.html" class="nav-item"><span class="nav-icon">üîå</span><span class="nav-text">Connect</span></a>
                <a href="servers.html" class="nav-item"><span class="nav-icon">üñ•Ô∏è</span><span class="nav-text">Servers</span></a>
                <a href="devices.html" class="nav-item"><span class="nav-icon">üì±</span><span class="nav-text">Devices</span></a>
                <a href="cameras.html" class="nav-item"><span class="nav-icon">üì∑</span><span class="nav-text">Cameras</span></a>
                <a href="scanner.html" class="nav-item"><span class="nav-icon">üîç</span><span class="nav-text">Scanner</span></a>
                <a href="certificates.html" class="nav-item"><span class="nav-icon">üìú</span><span class="nav-text">Certificates</span></a>
                <a href="settings.html" class="nav-item active"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-text">Settings</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <span class="user-avatar" id="userAvatar">U</span>
                    <div class="user-details">
                        <span class="user-name" id="userName">Loading...</span>
                        <span class="user-plan" id="userPlan">Free</span>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                <h1 class="page-title">Settings</h1>
            </header>

            <div class="content-area">
                <!-- Profile Section -->
                <div class="card">
                    <div class="card-header">
                        <h3>üë§ Profile</h3>
                    </div>
                    <div class="settings-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>First Name</label>
                                <input type="text" id="firstName" placeholder="First name">
                            </div>
                            <div class="form-group">
                                <label>Last Name</label>
                                <input type="text" id="lastName" placeholder="Last name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="email" placeholder="Email" disabled>
                            <span class="input-hint">Email cannot be changed</span>
                        </div>
                        <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
                    </div>
                </div>

                <!-- Subscription Section -->
                <div class="card">
                    <div class="card-header">
                        <h3>üí≥ Subscription</h3>
                    </div>
                    <div class="subscription-info">
                        <div class="sub-detail">
                            <span class="sub-label">Current Plan</span>
                            <span class="sub-value" id="currentPlan">Loading...</span>
                        </div>
                        <div class="sub-detail">
                            <span class="sub-label">Status</span>
                            <span class="sub-value sub-status active" id="subStatus">Active</span>
                        </div>
                        <div class="sub-detail">
                            <span class="sub-label">Next Billing</span>
                            <span class="sub-value" id="nextBilling">--</span>
                        </div>
                        <div class="sub-actions">
                            <button class="btn btn-secondary" onclick="upgradePlan()">Upgrade Plan</button>
                            <button class="btn btn-danger-outline" onclick="cancelSubscription()">Cancel Subscription</button>
                        </div>
                    </div>
                </div>

                <!-- Security Section -->
                <div class="card">
                    <div class="card-header">
                        <h3>üîí Security</h3>
                    </div>
                    <div class="settings-form">
                        <div class="form-group">
                            <label>Current Password</label>
                            <input type="password" id="currentPassword" placeholder="Enter current password">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>New Password</label>
                                <input type="password" id="newPassword" placeholder="New password">
                            </div>
                            <div class="form-group">
                                <label>Confirm Password</label>
                                <input type="password" id="confirmPassword" placeholder="Confirm new password">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
                    </div>
                    
                    <div class="settings-divider"></div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Two-Factor Authentication</h4>
                            <p>Add an extra layer of security to your account</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="twoFactorToggle" onchange="toggleTwoFactor()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Preferences Section -->
                <div class="card">
                    <div class="card-header">
                        <h3>‚öôÔ∏è Preferences</h3>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Auto-connect on startup</h4>
                            <p>Automatically connect to VPN when app starts</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="autoConnect">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Kill Switch</h4>
                            <p>Block internet if VPN disconnects unexpectedly</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="killSwitch">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Email notifications</h4>
                            <p>Receive emails about account activity</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="emailNotifications" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="card danger-card">
                    <div class="card-header">
                        <h3>‚ö†Ô∏è Danger Zone</h3>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Delete Account</h4>
                            <p>Permanently delete your account and all data</p>
                        </div>
                        <button class="btn btn-danger" onclick="deleteAccount()">Delete Account</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = '/api';
        let token = localStorage.getItem('truevault_token');
        let user = JSON.parse(localStorage.getItem('truevault_user') || '{}');

        if (!token) window.location.href = '/index.html#login';

        // Load user data
        document.getElementById('userName').textContent = user.first_name || 'User';
        document.getElementById('userPlan').textContent = user.is_vip ? 'VIP' : (user.plan || 'Basic');
        document.getElementById('userAvatar').textContent = (user.first_name || 'U')[0].toUpperCase();

        document.getElementById('firstName').value = user.first_name || '';
        document.getElementById('lastName').value = user.last_name || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('currentPlan').textContent = user.is_vip ? 'VIP (Lifetime)' : (user.plan || 'Basic');

        async function loadSubscription() {
            try {
                const res = await fetch(`${API_BASE}/billing/subscription.php`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success && data.data) {
                    document.getElementById('currentPlan').textContent = data.data.plan_type;
                    document.getElementById('subStatus').textContent = data.data.status;
                    if (data.data.end_date) {
                        document.getElementById('nextBilling').textContent = new Date(data.data.end_date).toLocaleDateString();
                    }
                }
            } catch (err) {
                console.error('Failed to load subscription');
            }
        }

        async function saveProfile() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();

            try {
                const res = await fetch(`${API_BASE}/users/update.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ first_name: firstName, last_name: lastName })
                });
                const data = await res.json();
                if (data.success) {
                    user.first_name = firstName;
                    user.last_name = lastName;
                    localStorage.setItem('truevault_user', JSON.stringify(user));
                    showToast('Profile updated!', 'success');
                } else {
                    showToast(data.error || 'Failed to update', 'error');
                }
            } catch (err) {
                showToast('Error updating profile', 'error');
            }
        }

        async function changePassword() {
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;

            if (!current || !newPass || !confirm) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (newPass !== confirm) {
                showToast('Passwords do not match', 'error');
                return;
            }

            if (newPass.length < 8) {
                showToast('Password must be at least 8 characters', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/auth/change-password.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ current_password: current, new_password: newPass })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Password changed!', 'success');
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    showToast(data.error || 'Failed to change password', 'error');
                }
            } catch (err) {
                showToast('Error changing password', 'error');
            }
        }

        function upgradePlan() {
            window.location.href = '/index.html#pricing';
        }

        async function cancelSubscription() {
            if (!confirm('Are you sure you want to cancel your subscription? You will lose access at the end of your billing period.')) return;

            try {
                const res = await fetch(`${API_BASE}/billing/subscription.php`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Subscription cancelled', 'success');
                    loadSubscription();
                } else {
                    showToast(data.error || 'Failed to cancel', 'error');
                }
            } catch (err) {
                showToast('Error cancelling subscription', 'error');
            }
        }

        async function deleteAccount() {
            if (!confirm('Are you SURE you want to delete your account? This cannot be undone!')) return;
            if (!confirm('This will permanently delete all your data, devices, cameras, and certificates. Continue?')) return;

            try {
                const res = await fetch(`${API_BASE}/users/delete.php`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    localStorage.clear();
                    window.location.href = '/index.html';
                } else {
                    showToast(data.error || 'Failed to delete account', 'error');
                }
            } catch (err) {
                showToast('Error deleting account', 'error');
            }
        }

        function toggleTwoFactor() {
            const enabled = document.getElementById('twoFactorToggle').checked;
            showToast(enabled ? '2FA setup coming soon!' : '2FA disabled', 'info');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
        function logout() { localStorage.clear(); window.location.href = '/index.html'; }

        loadSubscription();
    </script>

    <style>
        .settings-form { max-width: 600px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #888; font-size: 0.9rem; }
        .form-group input { width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; }
        .form-group input:disabled { opacity: 0.5; cursor: not-allowed; }
        .input-hint { font-size: 0.8rem; color: #666; margin-top: 0.25rem; display: block; }
        .subscription-info { display: flex; flex-wrap: wrap; gap: 2rem; }
        .sub-detail { display: flex; flex-direction: column; gap: 0.25rem; }
        .sub-label { font-size: 0.85rem; color: #888; }
        .sub-value { font-size: 1.1rem; font-weight: 600; }
        .sub-status.active { color: #00ff88; }
        .sub-actions { display: flex; gap: 1rem; margin-left: auto; }
        .settings-divider { border-top: 1px solid rgba(255,255,255,0.1); margin: 1.5rem 0; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; }
        .setting-info h4 { margin-bottom: 0.25rem; }
        .setting-info p { color: #888; font-size: 0.9rem; }
        .toggle { position: relative; width: 50px; height: 26px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: rgba(255,255,255,0.1); border-radius: 26px; transition: 0.3s; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: 0.3s; }
        .toggle input:checked + .toggle-slider { background: linear-gradient(90deg, #00d9ff, #00ff88); }
        .toggle input:checked + .toggle-slider:before { transform: translateX(24px); }
        .danger-card { border-color: rgba(255,80,80,0.3); }
        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-primary { background: linear-gradient(90deg, #00d9ff, #00ff88); color: #0f0f1a; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-danger { background: #ff5050; color: #fff; }
        .btn-danger-outline { background: transparent; border: 1px solid #ff5050; color: #ff5050; }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; z-index: 1000; color: #fff; }
        .toast-success { background: #00c853; }
        .toast-error { background: #ff5252; }
        .toast-info { background: #00d9ff; color: #0f0f1a; }
    </style>
</body>
</html>
