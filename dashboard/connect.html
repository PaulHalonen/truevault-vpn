<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect - TrueVault VPN</title>
    <link rel="stylesheet" href="assets/css/dashboard.css">
</head>
<body>
    <div id="app">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">üîê</span>
                    <span class="logo-text">TrueVault</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item" data-page="home">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="connect.html" class="nav-item active" data-page="connect">
                    <span class="nav-icon">üîå</span>
                    <span class="nav-text">Connect</span>
                </a>
                <a href="servers.html" class="nav-item" data-page="servers">
                    <span class="nav-icon">üñ•Ô∏è</span>
                    <span class="nav-text">Servers</span>
                </a>
                <a href="devices.html" class="nav-item" data-page="devices">
                    <span class="nav-icon">üì±</span>
                    <span class="nav-text">Devices</span>
                </a>
                <a href="cameras.html" class="nav-item" data-page="cameras">
                    <span class="nav-icon">üì∑</span>
                    <span class="nav-text">Cameras</span>
                </a>
                <a href="scanner.html" class="nav-item" data-page="scanner">
                    <span class="nav-icon">üîç</span>
                    <span class="nav-text">Scanner</span>
                </a>
                <a href="certificates.html" class="nav-item" data-page="certificates">
                    <span class="nav-icon">üìú</span>
                    <span class="nav-text">Certificates</span>
                </a>
                <a href="settings.html" class="nav-item" data-page="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-text">Settings</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <span class="user-avatar" id="userAvatar">U</span>
                    <div class="user-details">
                        <span class="user-name" id="userName">Loading...</span>
                        <span class="user-plan" id="userPlan">Free</span>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                <h1 class="page-title">Connect to VPN</h1>
                <div class="top-bar-actions">
                    <span class="connection-status" id="connectionStatus">
                        <span class="status-dot disconnected"></span>
                        Disconnected
                    </span>
                </div>
            </header>

            <div class="content-area">
                <!-- Connection Panel -->
                <div class="connect-panel">
                    <div class="connect-status-card">
                        <div class="connect-globe" id="connectGlobe">
                            <div class="globe-ring"></div>
                            <div class="globe-icon">üåê</div>
                        </div>
                        <div class="connect-info">
                            <h2 id="connectStatusText">Not Connected</h2>
                            <p id="connectLocation">Select a server to connect</p>
                        </div>
                        <button class="connect-btn" id="connectBtn" onclick="toggleConnection()">
                            Connect
                        </button>
                    </div>
                </div>

                <!-- Server Selection -->
                <div class="card">
                    <div class="card-header">
                        <h3>Select Server</h3>
                    </div>
                    <div class="server-list" id="serverList">
                        <div class="server-item" data-server="1" onclick="selectServer(1)">
                            <div class="server-flag">üá∫üá∏</div>
                            <div class="server-info">
                                <span class="server-name">US-East (New York)</span>
                                <span class="server-load">Load: <span class="load-value">--</span>%</span>
                            </div>
                            <div class="server-ping">-- ms</div>
                        </div>
                        <div class="server-item" data-server="3" onclick="selectServer(3)">
                            <div class="server-flag">üá∫üá∏</div>
                            <div class="server-info">
                                <span class="server-name">US-South (Dallas)</span>
                                <span class="server-load">Load: <span class="load-value">--</span>%</span>
                            </div>
                            <div class="server-ping">-- ms</div>
                        </div>
                        <div class="server-item" data-server="4" onclick="selectServer(4)">
                            <div class="server-flag">üá®üá¶</div>
                            <div class="server-info">
                                <span class="server-name">Canada (Toronto)</span>
                                <span class="server-load">Load: <span class="load-value">--</span>%</span>
                            </div>
                            <div class="server-ping">-- ms</div>
                        </div>
                        <div class="server-item vip-server" data-server="2" onclick="selectServer(2)">
                            <div class="server-flag">üá∫üá∏</div>
                            <div class="server-info">
                                <span class="server-name">US-Central VIP (St. Louis)</span>
                                <span class="server-badge vip">VIP Only</span>
                            </div>
                            <div class="server-ping">-- ms</div>
                        </div>
                    </div>
                </div>

                <!-- Config Download -->
                <div class="card">
                    <div class="card-header">
                        <h3>Download Config</h3>
                        <p class="card-subtitle">Get WireGuard config files for your devices</p>
                    </div>
                    <div class="config-download-grid">
                        <button class="config-btn" onclick="downloadConfig(1)">
                            <span class="config-icon">üìÑ</span>
                            <span class="config-name">TrueVaultNY.conf</span>
                        </button>
                        <button class="config-btn" onclick="downloadConfig(3)">
                            <span class="config-icon">üìÑ</span>
                            <span class="config-name">TrueVaultTX.conf</span>
                        </button>
                        <button class="config-btn" onclick="downloadConfig(4)">
                            <span class="config-icon">üìÑ</span>
                            <span class="config-name">TrueVaultCAN.conf</span>
                        </button>
                        <button class="config-btn vip-only" onclick="downloadConfig(2)" id="stlConfigBtn">
                            <span class="config-icon">üìÑ</span>
                            <span class="config-name">TrueVaultSTL.conf</span>
                            <span class="vip-badge">VIP</span>
                        </button>
                    </div>
                    <div class="config-instructions">
                        <h4>How to use:</h4>
                        <ol>
                            <li>Download WireGuard app for your device</li>
                            <li>Import the .conf file into WireGuard</li>
                            <li>Activate the tunnel to connect</li>
                        </ol>
                    </div>
                </div>

                <!-- Connection Stats -->
                <div class="card" id="connectionStats" style="display: none;">
                    <div class="card-header">
                        <h3>Connection Statistics</h3>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">Upload</span>
                            <span class="stat-value" id="uploadSpeed">0 KB/s</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Download</span>
                            <span class="stat-value" id="downloadSpeed">0 KB/s</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Connected Time</span>
                            <span class="stat-value" id="connectedTime">00:00:00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Your IP</span>
                            <span class="stat-value" id="currentIP">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = '/api';
        let token = localStorage.getItem('truevault_token');
        let user = JSON.parse(localStorage.getItem('truevault_user') || '{}');
        let selectedServer = null;
        let isConnected = false;

        // Check auth
        if (!token) {
            window.location.href = '/index.html#login';
        }

        // Load user info
        document.getElementById('userName').textContent = user.first_name || 'User';
        document.getElementById('userPlan').textContent = user.is_vip ? 'VIP' : (user.plan || 'Basic');
        document.getElementById('userAvatar').textContent = (user.first_name || 'U')[0].toUpperCase();

        // VIP check for STL server
        if (!user.is_vip) {
            document.querySelector('.server-item.vip-server').classList.add('disabled');
            document.getElementById('stlConfigBtn').classList.add('disabled');
        }

        function selectServer(serverId) {
            const item = document.querySelector(`[data-server="${serverId}"]`);
            if (item.classList.contains('disabled')) {
                showToast('This server is VIP only', 'error');
                return;
            }
            
            document.querySelectorAll('.server-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            selectedServer = serverId;
            
            const serverName = item.querySelector('.server-name').textContent;
            document.getElementById('connectLocation').textContent = serverName;
        }

        async function toggleConnection() {
            if (!selectedServer) {
                showToast('Please select a server first', 'error');
                return;
            }

            const btn = document.getElementById('connectBtn');
            btn.disabled = true;
            btn.textContent = isConnected ? 'Disconnecting...' : 'Connecting...';

            try {
                const endpoint = isConnected ? 'disconnect' : 'connect';
                const res = await fetch(`${API_BASE}/vpn/${endpoint}.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ server_id: selectedServer })
                });

                const data = await res.json();
                
                if (data.success) {
                    isConnected = !isConnected;
                    updateConnectionUI();
                    showToast(isConnected ? 'Connected!' : 'Disconnected', 'success');
                } else {
                    showToast(data.error || 'Connection failed', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }

            btn.disabled = false;
            btn.textContent = isConnected ? 'Disconnect' : 'Connect';
        }

        function updateConnectionUI() {
            const globe = document.getElementById('connectGlobe');
            const statusText = document.getElementById('connectStatusText');
            const statusDot = document.querySelector('.status-dot');
            const statsCard = document.getElementById('connectionStats');

            if (isConnected) {
                globe.classList.add('connected');
                statusText.textContent = 'Connected';
                statusDot.className = 'status-dot connected';
                statsCard.style.display = 'block';
                document.getElementById('connectionStatus').innerHTML = 
                    '<span class="status-dot connected"></span> Connected';
            } else {
                globe.classList.remove('connected');
                statusText.textContent = 'Not Connected';
                statusDot.className = 'status-dot disconnected';
                statsCard.style.display = 'none';
                document.getElementById('connectionStatus').innerHTML = 
                    '<span class="status-dot disconnected"></span> Disconnected';
            }
        }

        async function downloadConfig(serverId) {
            const btn = event.target.closest('.config-btn');
            if (btn.classList.contains('disabled')) {
                showToast('This config is VIP only', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/vpn/config.php?server_id=${serverId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Download failed');

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = getConfigName(serverId);
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                
                showToast('Config downloaded!', 'success');
            } catch (err) {
                showToast('Download failed', 'error');
            }
        }

        function getConfigName(serverId) {
            const names = {1: 'TrueVaultNY.conf', 2: 'TrueVaultSTL.conf', 3: 'TrueVaultTX.conf', 4: 'TrueVaultCAN.conf'};
            return names[serverId] || 'TrueVault.conf';
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        function logout() {
            localStorage.removeItem('truevault_token');
            localStorage.removeItem('truevault_user');
            window.location.href = '/index.html';
        }

        // Load servers
        async function loadServers() {
            try {
                const res = await fetch(`${API_BASE}/vpn/servers.php`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                // Update server list with real data if needed
            } catch (err) {
                console.error('Failed to load servers');
            }
        }

        loadServers();
    </script>

    <style>
        .connect-panel {
            margin-bottom: 2rem;
        }
        .connect-status-card {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(0, 255, 136, 0.1));
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
        }
        .connect-globe {
            width: 120px;
            height: 120px;
            margin: 0 auto 1.5rem;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .globe-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid rgba(0, 217, 255, 0.3);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .connect-globe.connected .globe-ring {
            border-color: #00ff88;
            animation: pulse-connected 1s infinite;
        }
        .globe-icon {
            font-size: 4rem;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.5; }
        }
        @keyframes pulse-connected {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        .connect-info h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .connect-info p {
            color: #888;
        }
        .connect-btn {
            margin-top: 1.5rem;
            padding: 1rem 3rem;
            font-size: 1.1rem;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            color: #0f0f1a;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 217, 255, 0.4);
        }
        .connect-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .server-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .server-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .server-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(0, 217, 255, 0.3);
        }
        .server-item.selected {
            background: rgba(0, 217, 255, 0.1);
            border-color: #00d9ff;
        }
        .server-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .server-item.vip-server {
            border-left: 3px solid #ffd700;
        }
        .server-flag {
            font-size: 1.5rem;
            margin-right: 1rem;
        }
        .server-info {
            flex: 1;
        }
        .server-name {
            display: block;
            font-weight: 500;
        }
        .server-load, .server-badge {
            font-size: 0.8rem;
            color: #888;
        }
        .server-badge.vip {
            background: linear-gradient(90deg, #ffd700, #ffaa00);
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        .server-ping {
            color: #00ff88;
            font-family: monospace;
        }
        .config-download-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .config-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #fff;
        }
        .config-btn:hover {
            background: rgba(0, 217, 255, 0.1);
            border-color: #00d9ff;
        }
        .config-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .config-btn.vip-only {
            border-color: rgba(255, 215, 0, 0.3);
        }
        .config-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .config-name {
            font-family: monospace;
            font-size: 0.9rem;
        }
        .vip-badge {
            background: linear-gradient(90deg, #ffd700, #ffaa00);
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        .config-instructions {
            background: rgba(0, 217, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
        }
        .config-instructions h4 {
            margin-bottom: 0.5rem;
            color: #00d9ff;
        }
        .config-instructions ol {
            margin-left: 1.2rem;
            color: #888;
        }
        .config-instructions li {
            margin-bottom: 0.3rem;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: #fff;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        .toast-success { background: #00c853; }
        .toast-error { background: #ff5252; }
        .toast-info { background: #00d9ff; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</body>
</html>
