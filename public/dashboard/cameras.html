<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cameras - TrueVault VPN</title>
    <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style id="theme-variables">:root{--colors-primary:#00d9ff;--colors-secondary:#00ff88;--colors-accent:#ff6b6b;--colors-background:#0f0f1a;--colors-background-secondary:#1a1a2e;--colors-text:#ffffff;--colors-text-muted:#888888;--colors-success:#00ff88;--colors-warning:#ffbb00;--colors-error:#ff5050;--gradients-primary:linear-gradient(90deg,#00d9ff,#00ff88);--gradients-background:linear-gradient(135deg,#0f0f1a,#1a1a2e);--buttons-border-radius:8px;--cards-border-radius:14px;--colors-border:rgba(255,255,255,0.08);--layout-sidebar-width:260px;}</style>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/dashboard.css">
    <style>
        .cameras-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
        .camera-card{background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:var(--cards-border-radius);overflow:hidden;transition:all 0.2s}
        .camera-card:hover{border-color:var(--colors-primary)}
        .camera-preview{position:relative;aspect-ratio:16/9;background:#000;display:flex;align-items:center;justify-content:center}
        .camera-preview img{width:100%;height:100%;object-fit:cover}
        .camera-preview .placeholder{font-size:3rem;opacity:0.3}
        .camera-status{position:absolute;top:10px;right:10px;padding:4px 10px;border-radius:15px;font-size:0.75rem;font-weight:600}
        .camera-status.online{background:var(--colors-success);color:#000}
        .camera-status.offline{background:var(--colors-error);color:#fff}
        .camera-info{padding:15px}
        .camera-info h3{font-size:1.1rem;margin-bottom:5px;display:flex;align-items:center;gap:8px}
        .camera-info .ip{font-family:monospace;font-size:0.9rem;color:var(--colors-primary)}
        .camera-info .vendor{font-size:0.85rem;color:var(--colors-text-muted);margin-top:5px}
        .camera-features{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
        .camera-feature{padding:3px 8px;background:rgba(255,255,255,0.05);border-radius:4px;font-size:0.75rem;color:var(--colors-text-muted)}
        .camera-actions{display:flex;gap:8px;margin-top:15px;padding-top:15px;border-top:1px solid var(--colors-border)}
        .empty-state{text-align:center;padding:60px 20px;background:rgba(255,255,255,0.02);border-radius:var(--cards-border-radius);border:1px dashed var(--colors-border)}
        .empty-state .icon{font-size:4rem;margin-bottom:20px;opacity:0.5}
        .empty-state h3{margin-bottom:10px}
        .empty-state p{color:var(--colors-text-muted);margin-bottom:20px}
        .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s}
        .modal.active{opacity:1;visibility:visible}
        .modal-content{background:var(--colors-background-secondary);border:1px solid var(--colors-border);border-radius:var(--cards-border-radius);padding:30px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px}
        .modal-header h2{font-size:1.4rem}
        .modal-close{background:none;border:none;color:var(--colors-text-muted);font-size:1.5rem;cursor:pointer}
        .loading-spinner{display:inline-block;width:20px;height:20px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:var(--colors-primary);animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body class="dashboard-body">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><span class="logo-icon">&#x1F6E1;</span><h1>TrueVault</h1></div>
        <nav class="sidebar-nav">
            <a href="/dashboard/" class="nav-item"><span class="nav-icon">&#x1F4CA;</span><span>Overview</span></a>
            <a href="/dashboard/connect.html" class="nav-item"><span class="nav-icon">&#x26A1;</span><span>Connect</span></a>
            <a href="/dashboard/servers.html" class="nav-item"><span class="nav-icon">&#x1F5A5;</span><span>Servers</span></a>
            <a href="/dashboard/identities.html" class="nav-item"><span class="nav-icon">&#x1F465;</span><span>Identities</span></a>
            <a href="/dashboard/certificates.html" class="nav-item"><span class="nav-icon">&#x1F4DC;</span><span>Certificates</span></a>
            <a href="/dashboard/devices.html" class="nav-item"><span class="nav-icon">&#x1F4F1;</span><span>Devices</span></a>
            <a href="/dashboard/cameras.html" class="nav-item active"><span class="nav-icon">&#x1F4F7;</span><span>Cameras</span></a>
            <a href="/dashboard/mesh.html" class="nav-item"><span class="nav-icon">&#x1F578;</span><span>Mesh Network</span></a>
            <div class="nav-divider"></div>
            <a href="/dashboard/scanner.html" class="nav-item"><span class="nav-icon">&#x1F4E1;</span><span>Network Scanner</span></a>
            <a href="/dashboard/settings.html" class="nav-item"><span class="nav-icon">&#x2699;</span><span>Settings</span></a>
            <a href="/dashboard/billing.html" class="nav-item"><span class="nav-icon">&#x1F4B3;</span><span>Billing</span></a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info"><div class="user-avatar">&#x1F464;</div><div class="user-details"><span class="user-name" id="userName">Loading...</span><span class="user-plan" id="userPlan">-</span></div></div>
            <button class="btn btn-secondary btn-small" onclick="TrueVault.Auth.logout()">Logout</button>
        </div>
    </aside>
    
    <main class="main-content">
        <header class="dashboard-header">
            <div>
                <h1>&#x1F4F7; IP Cameras</h1>
                <p class="text-muted">Monitor and manage your IP cameras remotely via VPN</p>
            </div>
            <div class="header-actions">
                <a href="/dashboard/scanner.html" class="btn btn-secondary">&#x1F4E1; Scan Network</a>
                <button class="btn btn-primary" onclick="showAddModal()">&#x2795; Add Camera</button>
            </div>
        </header>
        
        <section class="stats-grid" style="margin-bottom:30px">
            <div class="stat-card"><div class="stat-icon">&#x1F4F7;</div><div class="stat-content"><span class="stat-value" id="totalCameras">0</span><span class="stat-label">Total Cameras</span></div></div>
            <div class="stat-card"><div class="stat-icon">&#x2705;</div><div class="stat-content"><span class="stat-value" id="onlineCameras">0</span><span class="stat-label">Online</span></div></div>
            <div class="stat-card"><div class="stat-icon">&#x274C;</div><div class="stat-content"><span class="stat-value" id="offlineCameras">0</span><span class="stat-label">Offline</span></div></div>
            <div class="stat-card"><div class="stat-icon">&#x1F514;</div><div class="stat-content"><span class="stat-value" id="unviewedEvents">0</span><span class="stat-label">Unviewed Events</span></div></div>
        </section>
        
        <section id="camerasContainer">
            <div class="loading"><span class="loading-spinner"></span> Loading cameras...</div>
        </section>
    </main>
    
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header"><h2>&#x2795; Add Camera</h2><button class="modal-close" onclick="hideAddModal()">&times;</button></div>
            <form id="addCameraForm" onsubmit="addCamera(event)">
                <div class="form-group"><label>Camera Name *</label><input type="text" id="camera_name" name="camera_name" placeholder="Living Room Camera" required></div>
                <div class="form-group"><label>IP Address *</label><input type="text" id="ip_address" name="ip_address" placeholder="192.168.1.100" required></div>
                <div class="form-group"><label>Vendor</label><select id="vendor" name="vendor"><option value="">Auto-detect</option><option value="Geeni">Geeni</option><option value="Wyze">Wyze</option><option value="Hikvision">Hikvision</option><option value="Dahua">Dahua</option><option value="Amcrest">Amcrest</option><option value="Reolink">Reolink</option><option value="Ring">Ring</option><option value="Other">Other</option></select></div>
                <div class="form-group"><label>Username</label><input type="text" id="username" name="username" placeholder="admin"></div>
                <div class="form-group"><label>Password</label><input type="password" id="password" name="password" placeholder="Camera password"></div>
                <div class="form-group"><label>RTSP Port</label><input type="number" id="rtsp_port" name="rtsp_port" value="554"></div>
                <div style="display:flex;gap:10px;margin-top:25px"><button type="button" class="btn btn-secondary" onclick="hideAddModal()">Cancel</button><button type="submit" class="btn btn-primary" style="flex:1" id="addCameraBtn">&#x2795; Add Camera</button></div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header"><h2>&#x2699; Camera Settings</h2><button class="modal-close" onclick="hideEditModal()">&times;</button></div>
            <form id="editCameraForm" onsubmit="saveCamera(event)">
                <input type="hidden" id="edit_camera_id" name="id">
                <div class="form-group"><label>Camera Name *</label><input type="text" id="edit_camera_name" name="camera_name" required></div>
                <div class="form-group"><label>IP Address *</label><input type="text" id="edit_ip_address" name="ip_address" required></div>
                <div class="form-group"><label>Vendor</label><select id="edit_vendor" name="vendor"><option value="">Auto-detect</option><option value="Geeni">Geeni</option><option value="Wyze">Wyze</option><option value="Hikvision">Hikvision</option><option value="Dahua">Dahua</option><option value="Amcrest">Amcrest</option><option value="Reolink">Reolink</option><option value="Ring">Ring</option><option value="Other">Other</option></select></div>
                <div class="form-group"><label>Username</label><input type="text" id="edit_username" name="username"></div>
                <div class="form-group"><label>Password (leave blank to keep)</label><input type="password" id="edit_password" name="password"></div>
                <div class="form-group"><label>RTSP Port</label><input type="number" id="edit_rtsp_port" name="rtsp_port" value="554"></div>
                <div style="display:flex;gap:10px;margin-top:25px"><button type="button" class="btn btn-secondary" onclick="hideEditModal()">Cancel</button><button type="submit" class="btn btn-primary" style="flex:1" id="saveCameraBtn">&#x1F4BE; Save Changes</button></div>
            </form>
        </div>
    </div>
    
    <script src="/assets/js/theme-loader.js"></script>
    <script src="/assets/js/app.js"></script>
    <script>
        if (!TrueVault.Auth.requireAuth()) {}
        let cameras = [];
        
        document.addEventListener('DOMContentLoaded', async function() {
            await loadUserInfo();
            await loadCameras();
        });
        
        async function loadUserInfo() {
            const user = TrueVault.Auth.getUser();
            if (user) {
                document.getElementById('userName').textContent = user.first_name + ' ' + user.last_name;
                document.getElementById('userPlan').textContent = (user.plan_type || 'personal').charAt(0).toUpperCase() + (user.plan_type || 'personal').slice(1) + ' Plan';
            }
        }
        
        async function loadCameras() {
            const container = document.getElementById('camerasContainer');
            try {
                const result = await TrueVault.API.get('/devices/cameras.php');
                if (result.success) {
                    cameras = result.data.cameras || [];
                    const online = cameras.filter(c => c.is_online).length;
                    const events = cameras.reduce((sum, c) => sum + (parseInt(c.unviewed_events) || 0), 0);
                    document.getElementById('totalCameras').textContent = cameras.length;
                    document.getElementById('onlineCameras').textContent = online;
                    document.getElementById('offlineCameras').textContent = cameras.length - online;
                    document.getElementById('unviewedEvents').textContent = events;
                    renderCameras();
                } else {
                    container.innerHTML = '<p class="text-error">Failed to load cameras</p>';
                }
            } catch (error) {
                container.innerHTML = '<p class="text-error">Failed to load cameras</p>';
            }
        }
        
        function renderCameras() {
            const container = document.getElementById('camerasContainer');
            if (cameras.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">&#x1F4F7;</div><h3>No Cameras Found</h3><p>Add your first IP camera or use the network scanner to discover cameras.</p><div style="display:flex;gap:10px;justify-content:center"><a href="/dashboard/scanner.html" class="btn btn-secondary">&#x1F4E1; Scan Network</a><button class="btn btn-primary" onclick="showAddModal()">&#x2795; Add Camera</button></div></div>';
                return;
            }
            container.innerHTML = '<div class="cameras-grid">' + cameras.map(renderCamera).join('') + '</div>';
        }
        
        function renderCamera(camera) {
            const features = [];
            if (camera.is_ptz) features.push('PTZ');
            if (camera.has_audio) features.push('Audio');
            if (camera.has_night_vision) features.push('Night Vision');
            if (camera.has_motion_detection) features.push('Motion');
            return '<div class="camera-card"><div class="camera-preview">' + (camera.thumbnail_path ? '<img src="' + escapeHtml(camera.thumbnail_path) + '" alt="' + escapeHtml(camera.camera_name) + '">' : '<span class="placeholder">&#x1F4F7;</span>') + '<span class="camera-status ' + (camera.is_online ? 'online' : 'offline') + '">' + (camera.is_online ? '&#x2705; Online' : '&#x274C; Offline') + '</span></div><div class="camera-info"><h3>' + escapeHtml(camera.camera_name) + (camera.unviewed_events > 0 ? '<span class="badge badge-warning">' + camera.unviewed_events + '</span>' : '') + '</h3><div class="ip">' + escapeHtml(camera.ip_address) + '</div><div class="vendor">' + (escapeHtml(camera.vendor) || 'Unknown') + (camera.model ? ' - ' + escapeHtml(camera.model) : '') + '</div>' + (features.length > 0 ? '<div class="camera-features">' + features.map(f => '<span class="camera-feature">' + f + '</span>').join('') + '</div>' : '') + '<div class="camera-actions"><button class="btn btn-primary btn-small" onclick="viewCamera(' + camera.id + ')">&#x1F441; View</button><button class="btn btn-secondary btn-small" onclick="editCamera(' + camera.id + ')">&#x2699; Settings</button><button class="btn btn-danger btn-small" onclick="deleteCamera(' + camera.id + ')">&#x1F5D1;</button></div></div></div>';
        }
        
        function showAddModal() { document.getElementById('addCameraForm').reset(); document.getElementById('addModal').classList.add('active'); }
        function hideAddModal() { document.getElementById('addModal').classList.remove('active'); }
        function hideEditModal() { document.getElementById('editModal').classList.remove('active'); }
        
        async function addCamera(e) {
            e.preventDefault();
            const btn = document.getElementById('addCameraBtn');
            btn.disabled = true; btn.innerHTML = '<span class="loading-spinner"></span> Adding...';
            try {
                const data = { action: 'add', camera_name: document.getElementById('camera_name').value, ip_address: document.getElementById('ip_address').value, vendor: document.getElementById('vendor').value, username: document.getElementById('username').value, password: document.getElementById('password').value, rtsp_port: document.getElementById('rtsp_port').value };
                const result = await TrueVault.API.post('/devices/cameras.php', data);
                if (result.success) { TrueVault.Toast.success('Camera added!'); hideAddModal(); await loadCameras(); }
                else { TrueVault.Toast.error(result.error || 'Failed to add camera'); }
            } catch (error) { TrueVault.Toast.error('Failed to add camera'); }
            finally { btn.disabled = false; btn.innerHTML = '&#x2795; Add Camera'; }
        }
        
        function viewCamera(id) {
            const camera = cameras.find(c => c.id === id);
            if (camera) { if (!camera.is_online) { TrueVault.Toast.error('Camera is offline'); return; } TrueVault.Toast.info('Opening ' + camera.camera_name + '...'); if (camera.web_interface_url) window.open(camera.web_interface_url, '_blank'); }
        }
        
        function editCamera(id) {
            const camera = cameras.find(c => c.id === id);
            if (!camera) return;
            document.getElementById('edit_camera_id').value = camera.id;
            document.getElementById('edit_camera_name').value = camera.camera_name || '';
            document.getElementById('edit_ip_address').value = camera.ip_address || '';
            document.getElementById('edit_vendor').value = camera.vendor || '';
            document.getElementById('edit_username').value = camera.username || '';
            document.getElementById('edit_password').value = '';
            document.getElementById('edit_rtsp_port').value = camera.rtsp_port || 554;
            document.getElementById('editModal').classList.add('active');
        }
        
        async function saveCamera(e) {
            e.preventDefault();
            const btn = document.getElementById('saveCameraBtn');
            btn.disabled = true; btn.innerHTML = '<span class="loading-spinner"></span> Saving...';
            try {
                const data = { action: 'update', id: document.getElementById('edit_camera_id').value, camera_name: document.getElementById('edit_camera_name').value, ip_address: document.getElementById('edit_ip_address').value, vendor: document.getElementById('edit_vendor').value, username: document.getElementById('edit_username').value, rtsp_port: document.getElementById('edit_rtsp_port').value };
                const password = document.getElementById('edit_password').value;
                if (password) data.password = password;
                const result = await TrueVault.API.post('/devices/cameras.php', data);
                if (result.success) { TrueVault.Toast.success('Camera saved!'); hideEditModal(); await loadCameras(); }
                else { TrueVault.Toast.error(result.error || 'Failed to save'); }
            } catch (error) { TrueVault.Toast.error('Failed to save'); }
            finally { btn.disabled = false; btn.innerHTML = '&#x1F4BE; Save Changes'; }
        }
        
        async function deleteCamera(id) {
            const camera = cameras.find(c => c.id === id);
            if (!camera || !confirm('Remove camera "' + camera.camera_name + '"?')) return;
            try {
                const result = await TrueVault.API.post('/devices/cameras.php', { action: 'delete', id: id });
                if (result.success) { TrueVault.Toast.success('Camera removed'); await loadCameras(); }
                else { TrueVault.Toast.error(result.error || 'Failed to remove'); }
            } catch (error) { TrueVault.Toast.error('Failed to remove'); }
        }
        
        function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        
        document.getElementById('addModal').addEventListener('click', function(e) { if (e.target === this) hideAddModal(); });
        document.getElementById('editModal').addEventListener('click', function(e) { if (e.target === this) hideEditModal(); });
    </script>
</body>
</html>
