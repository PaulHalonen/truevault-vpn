<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devices - TrueVault VPN</title>
    <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style id="theme-variables">:root{--colors-primary:#00d9ff;--colors-secondary:#00ff88;--colors-accent:#ff6b6b;--colors-background:#0f0f1a;--colors-background-secondary:#1a1a2e;--colors-text:#ffffff;--colors-text-muted:#888888;--colors-success:#00ff88;--colors-warning:#ffbb00;--colors-error:#ff5050;--gradients-primary:linear-gradient(90deg,#00d9ff,#00ff88);--gradients-background:linear-gradient(135deg,#0f0f1a,#1a1a2e);--buttons-border-radius:8px;--cards-border-radius:14px;--colors-border:rgba(255,255,255,0.08);--layout-sidebar-width:260px;}</style>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/dashboard.css">
    <style>
        .devices-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;flex-wrap:wrap;gap:15px}
        .device-limit{background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:10px;padding:15px 20px;display:flex;align-items:center;gap:15px}
        .device-limit-bar{width:120px;height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden}
        .device-limit-fill{height:100%;background:var(--gradients-primary);border-radius:4px;transition:width 0.3s}
        .devices-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
        .device-card{background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:var(--cards-border-radius);padding:20px;transition:all 0.2s}
        .device-card:hover{border-color:var(--colors-primary)}
        .device-card.current{border-color:var(--colors-success);background:rgba(0,255,136,0.05)}
        .device-header{display:flex;align-items:center;gap:15px;margin-bottom:15px}
        .device-icon{font-size:2.5rem}
        .device-info h3{font-size:1.1rem;margin-bottom:3px}
        .device-info .type{color:var(--colors-text-muted);font-size:0.9rem}
        .device-details{padding:15px 0;border-top:1px solid var(--colors-border);border-bottom:1px solid var(--colors-border);margin:15px 0}
        .device-detail{display:flex;justify-content:space-between;padding:5px 0;font-size:0.9rem}
        .device-detail-label{color:var(--colors-text-muted)}
        .device-actions{display:flex;gap:8px}
        .add-device-card{background:rgba(255,255,255,0.02);border:2px dashed var(--colors-border);border-radius:var(--cards-border-radius);padding:40px;text-align:center;cursor:pointer;transition:all 0.2s}
        .add-device-card:hover{border-color:var(--colors-primary);background:rgba(255,255,255,0.04)}
        .add-device-card .icon{font-size:3rem;margin-bottom:15px;opacity:0.5}
        .setup-section{margin-top:40px}
        .setup-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:20px}
        .setup-option{background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:12px;padding:25px;text-align:center;cursor:pointer;transition:all 0.2s}
        .setup-option:hover{border-color:var(--colors-primary);background:rgba(255,255,255,0.05)}
        .setup-option .icon{font-size:2.5rem;margin-bottom:10px}
        .setup-option h4{margin-bottom:5px}
        .setup-option p{font-size:0.8rem;color:var(--colors-text-muted)}
        .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s}
        .modal.active{opacity:1;visibility:visible}
        .modal-content{background:var(--colors-background-secondary);border:1px solid var(--colors-border);border-radius:var(--cards-border-radius);padding:30px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px}
        .modal-close{background:none;border:none;color:var(--colors-text-muted);font-size:1.5rem;cursor:pointer}
        .config-box{background:rgba(0,0,0,0.3);border:1px solid var(--colors-border);border-radius:8px;padding:15px;font-family:monospace;font-size:0.85rem;white-space:pre-wrap;word-break:break-all;max-height:200px;overflow-y:auto}
        .qr-container{width:200px;height:200px;background:rgba(255,255,255,0.9);border-radius:8px;margin:20px auto;display:flex;align-items:center;justify-content:center}
        .qr-container img{max-width:180px;max-height:180px}
        .empty-state{text-align:center;padding:60px 20px}
        .empty-state .icon{font-size:4rem;margin-bottom:20px;opacity:0.5}
        .loading-state{text-align:center;padding:40px}
    </style>
</head>
<body class="dashboard-body">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><span class="logo-icon">&#x1F6E1;</span><h1>TrueVault</h1></div>
        <nav class="sidebar-nav">
            <a href="/dashboard/" class="nav-item"><span class="nav-icon">&#x1F4CA;</span><span>Overview</span></a>
            <a href="/dashboard/connect.html" class="nav-item"><span class="nav-icon">&#x26A1;</span><span>Connect</span></a>
            <a href="/dashboard/servers.html" class="nav-item"><span class="nav-icon">&#x1F5A5;</span><span>Servers</span></a>
            <a href="/dashboard/identities.html" class="nav-item"><span class="nav-icon">&#x1F464;</span><span>Identities</span></a>
            <a href="/dashboard/certificates.html" class="nav-item"><span class="nav-icon">&#x1F4DC;</span><span>Certificates</span></a>
            <a href="/dashboard/devices.html" class="nav-item active"><span class="nav-icon">&#x1F4F1;</span><span>Devices</span></a>
            <a href="/dashboard/cameras.html" class="nav-item"><span class="nav-icon">&#x1F4F7;</span><span>Cameras</span></a>
            <a href="/dashboard/mesh.html" class="nav-item"><span class="nav-icon">&#x1F578;</span><span>Mesh Network</span></a>
            <div class="nav-divider"></div>
            <a href="/dashboard/scanner.html" class="nav-item"><span class="nav-icon">&#x1F4E1;</span><span>Network Scanner</span></a>
            <a href="/dashboard/settings.html" class="nav-item"><span class="nav-icon">&#x2699;</span><span>Settings</span></a>
            <a href="/dashboard/billing.html" class="nav-item"><span class="nav-icon">&#x1F4B3;</span><span>Billing</span></a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info"><div class="user-avatar">&#x1F464;</div><div class="user-details"><span class="user-name" id="userName">Loading...</span><span class="user-plan" id="userPlan">-</span></div></div>
            <button class="btn btn-secondary btn-small" onclick="TrueVault.Auth.logout()">Logout</button>
        </div>
    </aside>
    
    <main class="main-content">
        <header class="dashboard-header">
            <div>
                <h1>&#x1F4F1; My Devices</h1>
                <p class="text-muted">Manage devices connected to your TrueVault account</p>
            </div>
        </header>
        
        <!-- Device Limit -->
        <div class="devices-header">
            <div class="device-limit">
                <span>Device Limit:</span>
                <div class="device-limit-bar">
                    <div class="device-limit-fill" id="limitFill" style="width:0%"></div>
                </div>
                <span id="limitText">0 / 0 devices</span>
            </div>
            <button class="btn btn-primary" onclick="showAddDeviceModal()">&#x2795; Add Device</button>
        </div>
        
        <!-- Devices Grid - DYNAMICALLY LOADED -->
        <div class="devices-grid" id="devicesGrid">
            <div class="loading-state">
                <p>Loading devices...</p>
            </div>
        </div>
        
        <!-- Setup Instructions -->
        <div class="setup-section">
            <h3>&#x1F4E6; Quick Setup</h3>
            <div class="setup-options">
                <div class="setup-option" onclick="showSetupModal('windows')">
                    <div class="icon">&#x1F5A5;</div>
                    <h4>Windows</h4>
                    <p>Download WireGuard app</p>
                </div>
                <div class="setup-option" onclick="showSetupModal('mac')">
                    <div class="icon">&#x1F4BB;</div>
                    <h4>macOS</h4>
                    <p>App Store or direct download</p>
                </div>
                <div class="setup-option" onclick="showSetupModal('ios')">
                    <div class="icon">&#x1F4F1;</div>
                    <h4>iOS</h4>
                    <p>Scan QR code</p>
                </div>
                <div class="setup-option" onclick="showSetupModal('android')">
                    <div class="icon">&#x1F4F2;</div>
                    <h4>Android</h4>
                    <p>Scan QR code</p>
                </div>
                <div class="setup-option" onclick="showSetupModal('linux')">
                    <div class="icon">&#x1F427;</div>
                    <h4>Linux</h4>
                    <p>Command line setup</p>
                </div>
                <div class="setup-option" onclick="showSetupModal('router')">
                    <div class="icon">&#x1F4F6;</div>
                    <h4>Router</h4>
                    <p>Whole-network VPN</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Add Device Modal -->
    <div class="modal" id="addDeviceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">&#x2795; Add New Device</h2>
                <button class="modal-close" onclick="hideModal('addDeviceModal')">&times;</button>
            </div>
            
            <form id="addDeviceForm" onsubmit="addDevice(event)">
                <div class="form-group">
                    <label>Device Name *</label>
                    <input type="text" id="deviceName" required placeholder="e.g., My iPhone, Work Laptop">
                </div>
                
                <div class="form-group">
                    <label>Device Type</label>
                    <select id="deviceType">
                        <option value="desktop">Desktop</option>
                        <option value="laptop">Laptop</option>
                        <option value="mobile">Mobile</option>
                        <option value="tablet">Tablet</option>
                        <option value="router">Router</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Platform</label>
                    <select id="devicePlatform">
                        <option value="windows">Windows</option>
                        <option value="macos">macOS</option>
                        <option value="linux">Linux</option>
                        <option value="ios">iOS</option>
                        <option value="android">Android</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">&#x2795; Add Device</button>
            </form>
        </div>
    </div>
    
    <!-- Config Modal -->
    <div class="modal" id="configModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="configTitle">&#x2699; Device Configuration</h2>
                <button class="modal-close" onclick="hideModal('configModal')">&times;</button>
            </div>
            
            <div id="configContent">
                <h4 style="margin:0 0 10px">&#x1F4F1; For Mobile (iOS/Android)</h4>
                <p class="text-muted" style="margin-bottom:15px">Scan this QR code with the WireGuard app:</p>
                <div class="qr-container" id="qrContainer">
                    <span style="color:#333">QR Loading...</span>
                </div>
                
                <h4 style="margin:20px 0 10px">&#x1F4BB; For Desktop</h4>
                <p class="text-muted" style="margin-bottom:15px">Copy this configuration to WireGuard:</p>
                <div class="config-box" id="configBox">Loading configuration...</div>
                
                <div style="display:flex;gap:10px;margin-top:20px">
                    <button class="btn btn-secondary" onclick="copyConfig()">&#x1F4CB; Copy Config</button>
                    <button class="btn btn-secondary" onclick="downloadConfig()">&#x1F4E5; Download .conf</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/assets/js/theme-loader.js"></script>
    <script src="/assets/js/app.js"></script>
    <script>
        // ============================================
        // DEVICES PAGE - DATABASE DRIVEN
        // ============================================
        
        let devices = [];
        let deviceLimit = 3; // Will be loaded from user plan
        let currentConfig = '';
        
        // Device type icons mapping
        const deviceIcons = {
            'desktop': '&#x1F5A5;',
            'laptop': '&#x1F4BB;',
            'mobile': '&#x1F4F1;',
            'tablet': '&#x1F4F2;',
            'router': '&#x1F4F6;',
            'other': '&#x1F4BB;'
        };
        
        // Platform display names
        const platformNames = {
            'windows': 'Windows',
            'macos': 'macOS',
            'linux': 'Linux',
            'ios': 'iOS',
            'android': 'Android',
            'other': 'Other'
        };
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            if (!TrueVault.Auth.requireAuth()) return;
            loadUserInfo();
            loadDevices();
        });
        
        // Load user info
        function loadUserInfo() {
            const user = TrueVault.Auth.getUser();
            if (user) {
                document.getElementById('userName').textContent = user.first_name + ' ' + user.last_name;
                const planName = user.plan_type.charAt(0).toUpperCase() + user.plan_type.slice(1);
                document.getElementById('userPlan').textContent = planName + ' Plan';
                
                // Set device limit based on plan
                const limits = {
                    'trial': 1,
                    'personal': 3,
                    'family': 10,
                    'business': 999,
                    'vip': 999
                };
                deviceLimit = limits[user.plan_type] || 3;
            }
        }
        
        // Load devices from API
        async function loadDevices() {
            try {
                const response = await TrueVault.API.get('/devices/list.php');
                if (response.success) {
                    devices = response.data.devices || [];
                    renderDevices();
                } else {
                    // No devices yet - show empty state
                    devices = [];
                    renderDevices();
                }
            } catch (error) {
                console.error('Error loading devices:', error);
                document.getElementById('devicesGrid').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">&#x26A0;</div>
                        <h3>Error Loading Devices</h3>
                        <p class="text-muted">Please try refreshing the page.</p>
                    </div>
                `;
            }
        }
        
        // Render devices grid
        function renderDevices() {
            const grid = document.getElementById('devicesGrid');
            
            // Update limit display
            const percentage = deviceLimit > 0 ? Math.min((devices.length / deviceLimit) * 100, 100) : 0;
            document.getElementById('limitFill').style.width = percentage + '%';
            document.getElementById('limitText').textContent = devices.length + ' / ' + (deviceLimit === 999 ? '∞' : deviceLimit) + ' devices';
            
            if (devices.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1">
                        <div class="icon">&#x1F4F1;</div>
                        <h3>No Devices Yet</h3>
                        <p class="text-muted">Add your first device to get started with TrueVault VPN.</p>
                        <button class="btn btn-primary" onclick="showAddDeviceModal()" style="margin-top:20px">&#x2795; Add Your First Device</button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            devices.forEach((device, index) => {
                const isCurrentDevice = device.is_current || false;
                const icon = deviceIcons[device.device_type] || deviceIcons.other;
                const platform = platformNames[device.platform] || device.platform;
                const lastActive = device.last_active ? formatDate(device.last_active) : 'Never';
                const addedDate = device.created_at ? formatDate(device.created_at) : 'Unknown';
                
                html += `
                    <div class="device-card ${isCurrentDevice ? 'current' : ''}">
                        <div class="device-header">
                            <span class="device-icon">${icon}</span>
                            <div class="device-info">
                                <h3>${escapeHtml(device.name)}</h3>
                                <div class="type">${device.device_type} • ${platform}</div>
                            </div>
                            ${isCurrentDevice ? '<span class="badge badge-success">This Device</span>' : ''}
                        </div>
                        <div class="device-details">
                            <div class="device-detail">
                                <span class="device-detail-label">Last Active</span>
                                <span>${lastActive}</span>
                            </div>
                            <div class="device-detail">
                                <span class="device-detail-label">Status</span>
                                <span class="badge badge-${device.status === 'active' ? 'success' : 'secondary'}">${device.status || 'inactive'}</span>
                            </div>
                            <div class="device-detail">
                                <span class="device-detail-label">Added</span>
                                <span>${addedDate}</span>
                            </div>
                        </div>
                        <div class="device-actions">
                            <button class="btn btn-secondary btn-small" onclick="viewConfig(${device.id})">&#x2699; Config</button>
                            <button class="btn btn-secondary btn-small" onclick="renameDevice(${device.id}, '${escapeHtml(device.name)}')">&#x270F; Rename</button>
                            ${!isCurrentDevice ? `<button class="btn btn-danger btn-small" onclick="removeDevice(${device.id})">&#x1F5D1;</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            // Add "Add Device" card if under limit
            if (devices.length < deviceLimit) {
                html += `
                    <div class="add-device-card" onclick="showAddDeviceModal()">
                        <div class="icon">&#x2795;</div>
                        <h3>Add New Device</h3>
                        <p class="text-muted">Connect another device to TrueVault</p>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }
        
        // Add new device
        async function addDevice(event) {
            event.preventDefault();
            
            const name = document.getElementById('deviceName').value.trim();
            const type = document.getElementById('deviceType').value;
            const platform = document.getElementById('devicePlatform').value;
            
            if (!name) {
                TrueVault.Toast.error('Please enter a device name');
                return;
            }
            
            if (devices.length >= deviceLimit) {
                TrueVault.Toast.error('Device limit reached. Upgrade your plan for more devices.');
                return;
            }
            
            try {
                const response = await TrueVault.API.post('/devices/index.php', {
                    action: 'add',
                    name: name,
                    device_type: type,
                    platform: platform
                });
                
                if (response.success) {
                    TrueVault.Toast.success('Device added successfully!');
                    hideModal('addDeviceModal');
                    document.getElementById('addDeviceForm').reset();
                    loadDevices(); // Reload list
                    
                    // Show config for new device
                    if (response.data && response.data.device_id) {
                        setTimeout(() => viewConfig(response.data.device_id), 500);
                    }
                } else {
                    TrueVault.Toast.error(response.error || 'Failed to add device');
                }
            } catch (error) {
                console.error('Error adding device:', error);
                TrueVault.Toast.error('Error adding device. Please try again.');
            }
        }
        
        // Remove device
        async function removeDevice(deviceId) {
            if (!confirm('Remove this device? It will need to be set up again.')) return;
            
            try {
                const response = await TrueVault.API.post('/devices/index.php', {
                    action: 'remove',
                    device_id: deviceId
                });
                
                if (response.success) {
                    TrueVault.Toast.success('Device removed');
                    loadDevices(); // Reload list
                } else {
                    TrueVault.Toast.error(response.error || 'Failed to remove device');
                }
            } catch (error) {
                console.error('Error removing device:', error);
                TrueVault.Toast.error('Error removing device');
            }
        }
        
        // Rename device
        async function renameDevice(deviceId, currentName) {
            const newName = prompt('Enter new device name:', currentName);
            if (!newName || newName === currentName) return;
            
            try {
                const response = await TrueVault.API.post('/devices/index.php', {
                    action: 'rename',
                    device_id: deviceId,
                    name: newName
                });
                
                if (response.success) {
                    TrueVault.Toast.success('Device renamed!');
                    loadDevices();
                } else {
                    TrueVault.Toast.error(response.error || 'Failed to rename device');
                }
            } catch (error) {
                TrueVault.Toast.error('Error renaming device');
            }
        }
        
        // View device configuration
        async function viewConfig(deviceId) {
            document.getElementById('configModal').classList.add('active');
            document.getElementById('configBox').textContent = 'Loading configuration...';
            
            try {
                const response = await TrueVault.API.get('/devices/index.php?action=config&device_id=' + deviceId);
                
                if (response.success && response.data.config) {
                    currentConfig = response.data.config;
                    document.getElementById('configBox').textContent = currentConfig;
                    
                    // Generate QR code if available
                    if (response.data.qr_code) {
                        document.getElementById('qrContainer').innerHTML = `<img src="${response.data.qr_code}" alt="QR Code">`;
                    }
                } else {
                    document.getElementById('configBox').textContent = 'Configuration not available. Please regenerate.';
                }
            } catch (error) {
                document.getElementById('configBox').textContent = 'Error loading configuration.';
            }
        }
        
        // Copy configuration
        function copyConfig() {
            if (!currentConfig) {
                TrueVault.Toast.error('No configuration to copy');
                return;
            }
            navigator.clipboard.writeText(currentConfig);
            TrueVault.Toast.success('Configuration copied!');
        }
        
        // Download configuration
        function downloadConfig() {
            if (!currentConfig) {
                TrueVault.Toast.error('No configuration to download');
                return;
            }
            const blob = new Blob([currentConfig], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'truevault.conf';
            a.click();
            URL.revokeObjectURL(url);
            TrueVault.Toast.success('Configuration downloaded!');
        }
        
        // Show modals
        function showAddDeviceModal() {
            if (devices.length >= deviceLimit) {
                TrueVault.Toast.error('Device limit reached. Upgrade your plan for more devices.');
                return;
            }
            document.getElementById('addDeviceModal').classList.add('active');
        }
        
        function showSetupModal(platform) {
            showAddDeviceModal();
            if (platform) {
                document.getElementById('devicePlatform').value = platform;
            }
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Utility functions
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Now';
            if (diffMins < 60) return diffMins + ' minutes ago';
            if (diffHours < 24) return diffHours + ' hours ago';
            if (diffDays < 7) return diffDays + ' days ago';
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
