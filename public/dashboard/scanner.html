<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Scanner - TrueVault VPN</title>
    <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style id="theme-variables">:root{--colors-primary:#00d9ff;--colors-secondary:#00ff88;--colors-accent:#ff6b6b;--colors-background:#0f0f1a;--colors-background-secondary:#1a1a2e;--colors-text:#ffffff;--colors-text-muted:#888888;--colors-success:#00ff88;--colors-warning:#ffbb00;--colors-error:#ff5050;--gradients-primary:linear-gradient(90deg,#00d9ff,#00ff88);--gradients-background:linear-gradient(135deg,#0f0f1a,#1a1a2e);--buttons-border-radius:8px;--cards-border-radius:14px;--colors-border:rgba(255,255,255,0.08);--layout-sidebar-width:260px;}</style>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/dashboard.css">
    <style>
        .scanner-header{display:flex;align-items:center;gap:20px;margin-bottom:30px;padding:25px;background:linear-gradient(135deg,rgba(0,217,255,0.1),rgba(0,255,136,0.1));border:1px solid rgba(0,217,255,0.2);border-radius:var(--cards-border-radius)}
        .scanner-header .icon{font-size:3rem}
        .scanner-header h2{margin-bottom:5px}
        .scanner-progress{margin:30px 0}
        .progress-bar{height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden}
        .progress-fill{height:100%;background:var(--gradients-primary);transition:width 0.3s}
        .progress-text{display:flex;justify-content:space-between;margin-top:10px;font-size:0.9rem;color:var(--colors-text-muted)}
        .devices-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px}
        .device-card{background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:var(--cards-border-radius);padding:15px;cursor:pointer;transition:all 0.2s}
        .device-card:hover{border-color:var(--colors-primary)}
        .device-card.selected{border-color:var(--colors-secondary);background:rgba(0,255,136,0.05)}
        .device-card.camera{border-left:3px solid var(--colors-accent)}
        .device-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
        .device-icon{font-size:1.8rem}
        .device-info h4{font-size:1rem;margin-bottom:2px}
        .device-info .ip{font-family:monospace;font-size:0.85rem;color:var(--colors-primary)}
        .device-meta{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
        .device-tag{padding:3px 8px;background:rgba(255,255,255,0.05);border-radius:4px;font-size:0.75rem;color:var(--colors-text-muted)}
        .device-tag.port{color:var(--colors-secondary)}
        .device-tag.camera{background:rgba(255,107,107,0.15);color:var(--colors-accent)}
        .scanner-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:25px;padding-top:25px;border-top:1px solid var(--colors-border)}
        .filter-bar{display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap}
        .filter-btn{padding:8px 16px;background:rgba(255,255,255,0.05);border:1px solid var(--colors-border);border-radius:20px;color:var(--colors-text);cursor:pointer;transition:all 0.2s}
        .filter-btn:hover,.filter-btn.active{background:var(--colors-primary);color:var(--colors-background);border-color:var(--colors-primary)}
        .results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .select-all{display:flex;align-items:center;gap:8px;cursor:pointer}
        .select-all input{width:18px;height:18px}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .scanning .progress-fill{animation:pulse 1s infinite}
    </style>
</head>
<body class="dashboard-body">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><span class="logo-icon">ğŸ›¡ï¸</span><h1>TrueVault</h1></div>
        <nav class="sidebar-nav">
            <a href="/dashboard/" class="nav-item"><span class="nav-icon">ğŸ“Š</span><span>Overview</span></a>
            <a href="/dashboard/connect.html" class="nav-item"><span class="nav-icon">ğŸ”Œ</span><span>Connect</span></a>
            <a href="/dashboard/servers.html" class="nav-item"><span class="nav-icon">ğŸŒ</span><span>Servers</span></a>
            <a href="/dashboard/identities.html" class="nav-item"><span class="nav-icon">ğŸ­</span><span>Identities</span></a>
            <a href="/dashboard/certificates.html" class="nav-item"><span class="nav-icon">ğŸ“œ</span><span>Certificates</span></a>
            <a href="/dashboard/devices.html" class="nav-item"><span class="nav-icon">ğŸ“±</span><span>Devices</span></a>
            <a href="/dashboard/cameras.html" class="nav-item"><span class="nav-icon">ğŸ“·</span><span>Cameras</span></a>
            <a href="/dashboard/mesh.html" class="nav-item"><span class="nav-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span><span>Mesh Network</span></a>
            <div class="nav-divider"></div>
            <a href="/dashboard/scanner.html" class="nav-item active"><span class="nav-icon">ğŸ”</span><span>Network Scanner</span></a>
            <a href="/dashboard/settings.html" class="nav-item"><span class="nav-icon">âš™ï¸</span><span>Settings</span></a>
            <a href="/dashboard/billing.html" class="nav-item"><span class="nav-icon">ğŸ’³</span><span>Billing</span></a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info"><div class="user-avatar">ğŸ‘¤</div><div class="user-details"><span class="user-name" id="userName">Loading...</span><span class="user-plan" id="userPlan">-</span></div></div>
            <button class="btn btn-secondary btn-small" onclick="TrueVault.Auth.logout()">Logout</button>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <header class="dashboard-header">
            <div>
                <h1>ğŸ” Network Scanner</h1>
                <p class="text-muted">Discover devices on your local network</p>
            </div>
        </header>
        
        <!-- Scanner Header -->
        <div class="scanner-header">
            <span class="icon">ğŸ”</span>
            <div style="flex:1">
                <h2>Scan Your Network</h2>
                <p class="text-muted">Find IP cameras, smart devices, printers, and more on your local network.</p>
            </div>
            <button class="btn btn-primary btn-large" id="scanBtn" onclick="startScan()">
                <span id="scanBtnText">ğŸš€ Start Scan</span>
            </button>
        </div>
        
        <!-- Progress -->
        <div class="scanner-progress" id="progressSection" style="display:none">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width:0%"></div>
            </div>
            <div class="progress-text">
                <span id="progressMessage">Initializing...</span>
                <span id="progressPercent">0%</span>
            </div>
        </div>
        
        <!-- Results -->
        <div id="resultsSection" style="display:none">
            <div class="filter-bar">
                <button class="filter-btn active" data-filter="all">All (<span id="countAll">0</span>)</button>
                <button class="filter-btn" data-filter="camera">ğŸ“· Cameras (<span id="countCameras">0</span>)</button>
                <button class="filter-btn" data-filter="printer">ğŸ–¨ï¸ Printers (<span id="countPrinters">0</span>)</button>
                <button class="filter-btn" data-filter="smart">ğŸ  Smart Home (<span id="countSmart">0</span>)</button>
                <button class="filter-btn" data-filter="other">ğŸ“± Other (<span id="countOther">0</span>)</button>
            </div>
            
            <div class="results-header">
                <label class="select-all">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    <span>Select All</span>
                </label>
                <span class="text-muted" id="selectedCount">0 selected</span>
            </div>
            
            <div class="devices-grid" id="devicesGrid"></div>
            
            <div class="scanner-actions">
                <button class="btn btn-primary" onclick="syncSelected()" id="syncBtn" disabled>
                    â˜ï¸ Sync Selected to TrueVault
                </button>
                <button class="btn btn-secondary" onclick="addCamerasSelected()">
                    ğŸ“· Add Selected Cameras
                </button>
                <button class="btn btn-secondary" onclick="exportResults()">
                    ğŸ“¥ Export Results
                </button>
            </div>
        </div>
        
        <!-- Instructions when no scan -->
        <div id="instructionsSection">
            <div class="card" style="margin-top:20px">
                <h3 style="margin-bottom:15px">ğŸ“‹ How It Works</h3>
                <ol style="color:var(--colors-text-muted);line-height:2">
                    <li>Make sure you're connected to your local network (NOT connected to VPN)</li>
                    <li>Click "Start Scan" to discover all devices on your network</li>
                    <li>The scanner will identify device types by MAC address and open ports</li>
                    <li>Select devices you want to manage through TrueVault VPN</li>
                    <li>Click "Sync" to add them to your TrueVault account</li>
                </ol>
            </div>
            
            <div class="card" style="margin-top:20px">
                <h3 style="margin-bottom:15px">ğŸ”§ Standalone Scanner Tool</h3>
                <p class="text-muted" style="margin-bottom:15px">
                    For best results, download our standalone scanner tool that runs directly on your computer:
                </p>
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                    <a href="/downloads/truthvault-scanner-windows.zip" class="btn btn-secondary">
                        ğŸªŸ Windows
                    </a>
                    <a href="/downloads/truthvault-scanner-mac.zip" class="btn btn-secondary">
                        ğŸ macOS
                    </a>
                    <a href="/downloads/truthvault-scanner-linux.zip" class="btn btn-secondary">
                        ğŸ§ Linux
                    </a>
                </div>
            </div>
        </div>
    </main>
    
    <script src="/assets/js/theme-loader.js"></script>
    <script src="/assets/js/app.js"></script>
    <script>
        if (!TrueVault.Auth.requireAuth()) {}
        
        let devices = [];
        let selected = new Set();
        let scanning = false;
        let currentFilter = 'all';
        
        // Load user info
        const user = TrueVault.Auth.getUser();
        if (user) {
            document.getElementById('userName').textContent = user.first_name + ' ' + user.last_name;
            document.getElementById('userPlan').textContent = user.plan_type.charAt(0).toUpperCase() + user.plan_type.slice(1) + ' Plan';
        }
        
        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                renderDevices();
            });
        });
        
        function startScan() {
            if (scanning) return;
            
            scanning = true;
            devices = [];
            selected.clear();
            
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('scanBtnText').textContent = 'â³ Scanning...';
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('progressSection').classList.add('scanning');
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('instructionsSection').style.display = 'none';
            
            // Simulate scan progress (in production, this would use WebSocket or polling)
            simulateScan();
        }
        
        function simulateScan() {
            let progress = 0;
            const messages = [
                'Discovering network range...',
                'Pinging hosts...',
                'Reading ARP table...',
                'Identifying devices...',
                'Checking ports...',
                'Analyzing device types...',
                'Finalizing results...'
            ];
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
                document.getElementById('progressMessage').textContent = messages[Math.floor(progress / 15)] || messages[messages.length - 1];
                
                if (progress >= 100) {
                    clearInterval(interval);
                    finishScan();
                }
            }, 500);
        }
        
        function finishScan() {
            scanning = false;
            document.getElementById('scanBtn').disabled = false;
            document.getElementById('scanBtnText').textContent = 'ğŸ”„ Scan Again';
            document.getElementById('progressSection').classList.remove('scanning');
            document.getElementById('resultsSection').style.display = 'block';
            
            // Generate sample devices (in production, this comes from actual scan)
            devices = generateSampleDevices();
            updateCounts();
            renderDevices();
            
            TrueVault.Toast.success(`Found ${devices.length} devices!`);
        }
        
        function generateSampleDevices() {
            return [
                { id: 1, ip: '192.168.1.100', mac: 'D8:1D:2E:AA:BB:CC', hostname: 'geeni-cam-1', vendor: 'Geeni', type: 'camera', icon: 'ğŸ“·', ports: [80, 554, 8080] },
                { id: 2, ip: '192.168.1.101', mac: '2C:AA:8E:DD:EE:FF', hostname: 'wyze-cam', vendor: 'Wyze', type: 'camera', icon: 'ğŸ“·', ports: [80, 554] },
                { id: 3, ip: '192.168.1.102', mac: 'D8:EB:46:11:22:33', hostname: 'hikvision-dvr', vendor: 'Hikvision', type: 'camera', icon: 'ğŸ“·', ports: [80, 554, 8000] },
                { id: 4, ip: '192.168.1.50', mac: '3C:A9:F4:44:55:66', hostname: 'HP-Printer', vendor: 'HP Printer', type: 'printer', icon: 'ğŸ–¨ï¸', ports: [80, 443, 9100] },
                { id: 5, ip: '192.168.1.51', mac: '00:26:AB:77:88:99', hostname: 'EPSON-WF', vendor: 'Epson Printer', type: 'printer', icon: 'ğŸ–¨ï¸', ports: [80, 631, 9100] },
                { id: 6, ip: '192.168.1.30', mac: 'FC:A1:83:AA:BB:CC', hostname: 'echo-dot', vendor: 'Amazon Echo', type: 'smart', icon: 'ğŸ”Š', ports: [8008] },
                { id: 7, ip: '192.168.1.31', mac: '18:B4:30:DD:EE:FF', hostname: 'nest-thermostat', vendor: 'Nest', type: 'smart', icon: 'ğŸ ', ports: [443] },
                { id: 8, ip: '192.168.1.32', mac: 'B8:3E:59:11:22:33', hostname: 'roku-tv', vendor: 'Roku', type: 'smart', icon: 'ğŸ“º', ports: [8060] },
                { id: 9, ip: '192.168.1.200', mac: '28:3F:69:44:55:66', hostname: 'playstation', vendor: 'PlayStation', type: 'other', icon: 'ğŸ®', ports: [987, 9295] },
                { id: 10, ip: '192.168.1.201', mac: 'B8:27:EB:77:88:99', hostname: 'raspberrypi', vendor: 'Raspberry Pi', type: 'other', icon: 'ğŸ–¥ï¸', ports: [22, 80] },
            ];
        }
        
        function updateCounts() {
            const cameras = devices.filter(d => d.type === 'camera').length;
            const printers = devices.filter(d => d.type === 'printer').length;
            const smart = devices.filter(d => d.type === 'smart').length;
            const other = devices.filter(d => d.type === 'other').length;
            
            document.getElementById('countAll').textContent = devices.length;
            document.getElementById('countCameras').textContent = cameras;
            document.getElementById('countPrinters').textContent = printers;
            document.getElementById('countSmart').textContent = smart;
            document.getElementById('countOther').textContent = other;
        }
        
        function renderDevices() {
            const filtered = currentFilter === 'all' ? devices : devices.filter(d => d.type === currentFilter);
            const grid = document.getElementById('devicesGrid');
            
            if (filtered.length === 0) {
                grid.innerHTML = '<p class="text-muted" style="padding:20px">No devices found in this category</p>';
                return;
            }
            
            grid.innerHTML = filtered.map(d => `
                <div class="device-card ${selected.has(d.id) ? 'selected' : ''} ${d.type === 'camera' ? 'camera' : ''}" 
                     onclick="toggleDevice(${d.id})">
                    <div class="device-header">
                        <span class="device-icon">${d.icon}</span>
                        <div class="device-info">
                            <h4>${d.hostname || d.vendor || 'Unknown Device'}</h4>
                            <div class="ip">${d.ip}</div>
                        </div>
                    </div>
                    <div class="device-meta">
                        <span class="device-tag">${d.vendor}</span>
                        ${d.type === 'camera' ? '<span class="device-tag camera">CAMERA</span>' : ''}
                        ${d.ports.slice(0, 3).map(p => `<span class="device-tag port">:${p}</span>`).join('')}
                    </div>
                </div>
            `).join('');
            
            updateSelectedCount();
        }
        
        function toggleDevice(id) {
            if (selected.has(id)) {
                selected.delete(id);
            } else {
                selected.add(id);
            }
            renderDevices();
        }
        
        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAll');
            const filtered = currentFilter === 'all' ? devices : devices.filter(d => d.type === currentFilter);
            
            if (checkbox.checked) {
                filtered.forEach(d => selected.add(d.id));
            } else {
                filtered.forEach(d => selected.delete(d.id));
            }
            renderDevices();
        }
        
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selected.size + ' selected';
            document.getElementById('syncBtn').disabled = selected.size === 0;
        }
        
        async function syncSelected() {
            const selectedDevices = devices.filter(d => selected.has(d.id)).map(d => ({
                ip: d.ip,
                mac: d.mac,
                hostname: d.hostname,
                vendor: d.vendor,
                type: d.type,
                open_ports: d.ports
            }));
            
            if (selectedDevices.length === 0) {
                TrueVault.Toast.error('No devices selected');
                return;
            }
            
            document.getElementById('syncBtn').disabled = true;
            document.getElementById('syncBtn').textContent = 'â³ Syncing...';
            
            const result = await TrueVault.API.post('/scanner/sync.php', { devices: selectedDevices });
            
            if (result.success) {
                TrueVault.Toast.success(`Synced ${result.data.stats.total} devices! (${result.data.stats.new_devices} new, ${result.data.stats.new_cameras} cameras)`);
            } else {
                TrueVault.Toast.error(result.error || 'Sync failed');
            }
            
            document.getElementById('syncBtn').disabled = false;
            document.getElementById('syncBtn').textContent = 'â˜ï¸ Sync Selected to TrueVault';
        }
        
        function addCamerasSelected() {
            const cameras = devices.filter(d => selected.has(d.id) && d.type === 'camera');
            if (cameras.length === 0) {
                TrueVault.Toast.error('No cameras selected');
                return;
            }
            TrueVault.Toast.info(`Adding ${cameras.length} cameras...`);
            // In production: API call to add cameras
        }
        
        function exportResults() {
            const csv = 'IP,MAC,Hostname,Vendor,Type,Ports\n' + 
                devices.map(d => `${d.ip},${d.mac},${d.hostname || ''},${d.vendor},${d.type},"${d.ports.join(', ')}"`).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'truevault-scan-results.csv';
            a.click();
            
            TrueVault.Toast.success('Results exported!');
        }
    </script>
</body>
</html>
