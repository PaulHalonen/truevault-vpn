<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regional Identities - TrueVault VPN</title>
    <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style id="theme-variables">:root{--colors-primary:#00d9ff;--colors-secondary:#00ff88;--colors-accent:#ff6b6b;--colors-background:#0f0f1a;--colors-background-secondary:#1a1a2e;--colors-text:#ffffff;--colors-text-muted:#888888;--colors-success:#00ff88;--colors-warning:#ffbb00;--colors-error:#ff5050;--gradients-primary:linear-gradient(90deg,#00d9ff,#00ff88);--gradients-background:linear-gradient(135deg,#0f0f1a,#1a1a2e);--buttons-border-radius:8px;--cards-border-radius:14px;--colors-border:rgba(255,255,255,0.08);--layout-sidebar-width:260px;}</style>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/dashboard.css">
    <style>
        .identities-intro{background:linear-gradient(135deg,rgba(0,217,255,0.1),rgba(0,255,136,0.05));border:1px solid rgba(0,217,255,0.2);border-radius:var(--cards-border-radius);padding:30px;margin-bottom:30px}
        .identities-intro h2{margin-bottom:10px}
        .stats-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:25px}
        .stat-card{background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:10px;padding:20px;text-align:center}
        .stat-card .number{font-size:2rem;font-weight:700;background:linear-gradient(90deg,var(--colors-primary),var(--colors-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .stat-card .label{color:var(--colors-text-muted);font-size:0.85rem;margin-top:5px}
        .identities-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
        .identity-card{background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:var(--cards-border-radius);overflow:hidden;transition:all 0.2s}
        .identity-card:hover{border-color:var(--colors-primary)}
        .identity-card.active{border-color:var(--colors-success);background:rgba(0,255,136,0.05)}
        .identity-card.locked{opacity:0.6}
        .identity-header{display:flex;align-items:center;gap:15px;padding:20px;border-bottom:1px solid var(--colors-border)}
        .identity-flag{font-size:3rem}
        .identity-info{flex:1}
        .identity-info h3{font-size:1.2rem;margin-bottom:3px}
        .identity-info .region{color:var(--colors-text-muted);font-size:0.9rem}
        .identity-details{padding:20px}
        .identity-detail{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03)}
        .identity-detail:last-child{border-bottom:none}
        .identity-detail-label{color:var(--colors-text-muted);font-size:0.9rem}
        .identity-detail-value{font-family:monospace;font-size:0.9rem}
        .identity-actions{padding:15px 20px;background:rgba(0,0,0,0.2);display:flex;gap:10px}
        .usage-info{margin-top:15px;padding:15px;background:rgba(0,0,0,0.2);border-radius:8px}
        .usage-bar{height:6px;background:rgba(255,255,255,0.1);border-radius:3px;margin-top:10px;overflow:hidden}
        .usage-fill{height:100%;background:var(--colors-primary);border-radius:3px;transition:width 0.3s}
        .create-identity{background:rgba(255,255,255,0.02);border:2px dashed var(--colors-border);border-radius:var(--cards-border-radius);padding:40px;text-align:center;cursor:pointer;transition:all 0.2s}
        .create-identity:hover{border-color:var(--colors-primary);background:rgba(255,255,255,0.04)}
        .create-identity .icon{font-size:3rem;margin-bottom:15px;opacity:0.5}
        .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s}
        .modal.active{opacity:1;visibility:visible}
        .modal-content{background:var(--colors-background-secondary);border:1px solid var(--colors-border);border-radius:var(--cards-border-radius);padding:30px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px}
        .modal-close{background:none;border:none;color:var(--colors-text-muted);font-size:1.5rem;cursor:pointer}
        .region-selector{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:20px 0}
        .region-option{padding:15px;background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:8px;cursor:pointer;text-align:center;transition:all 0.2s}
        .region-option:hover{border-color:var(--colors-primary)}
        .region-option.selected{border-color:var(--colors-secondary);background:rgba(0,255,136,0.1)}
        .region-option.disabled{opacity:0.4;cursor:not-allowed}
        .region-option .flag{font-size:1.5rem;margin-bottom:5px}
        .empty-state{text-align:center;padding:60px 20px;color:var(--colors-text-muted)}
        .empty-state .icon{font-size:4rem;margin-bottom:20px;opacity:0.3}
        .loading-spinner{display:inline-block;width:20px;height:20px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:var(--colors-primary);animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body class="dashboard-body">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><span class="logo-icon">&#x1F6E1;</span><h1>TrueVault</h1></div>
        <nav class="sidebar-nav">
            <a href="/dashboard/" class="nav-item"><span class="nav-icon">&#x1F4CA;</span><span>Overview</span></a>
            <a href="/dashboard/connect.html" class="nav-item"><span class="nav-icon">&#x26A1;</span><span>Connect</span></a>
            <a href="/dashboard/servers.html" class="nav-item"><span class="nav-icon">&#x1F5A5;</span><span>Servers</span></a>
            <a href="/dashboard/identities.html" class="nav-item active"><span class="nav-icon">&#x1F465;</span><span>Identities</span></a>
            <a href="/dashboard/certificates.html" class="nav-item"><span class="nav-icon">&#x1F4DC;</span><span>Certificates</span></a>
            <a href="/dashboard/devices.html" class="nav-item"><span class="nav-icon">&#x1F4F1;</span><span>Devices</span></a>
            <a href="/dashboard/cameras.html" class="nav-item"><span class="nav-icon">&#x1F4F7;</span><span>Cameras</span></a>
            <a href="/dashboard/mesh.html" class="nav-item"><span class="nav-icon">&#x1F578;</span><span>Mesh Network</span></a>
            <div class="nav-divider"></div>
            <a href="/dashboard/scanner.html" class="nav-item"><span class="nav-icon">&#x1F4E1;</span><span>Network Scanner</span></a>
            <a href="/dashboard/settings.html" class="nav-item"><span class="nav-icon">&#x2699;</span><span>Settings</span></a>
            <a href="/dashboard/billing.html" class="nav-item"><span class="nav-icon">&#x1F4B3;</span><span>Billing</span></a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info"><div class="user-avatar">&#x1F464;</div><div class="user-details"><span class="user-name" id="userName">Loading...</span><span class="user-plan" id="userPlan">-</span></div></div>
            <button class="btn btn-secondary btn-small" onclick="TrueVault.Auth.logout()">Logout</button>
        </div>
    </aside>
    
    <main class="main-content">
        <header class="dashboard-header">
            <div>
                <h1>&#x1F465; Regional Identities</h1>
                <p class="text-muted">Persistent digital personas for different regions</p>
            </div>
            <button class="btn btn-primary" onclick="showCreateModal()">&#x2795; New Identity</button>
        </header>
        
        <!-- Intro -->
        <div class="identities-intro">
            <h2>&#x1F9E0; Smart Identity Router</h2>
            <p class="text-muted">Create persistent digital identities for different regions. When you connect to your Canadian bank, it's not just a Canadian IP - it's the <strong>same</strong> Canadian IP every time, with consistent browser fingerprints and timezone settings. Banks never flag you again.</p>
        </div>
        
        <!-- Stats -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="number" id="totalIdentities">0</div>
                <div class="label">Total Identities</div>
            </div>
            <div class="stat-card">
                <div class="number" id="activeIdentity">None</div>
                <div class="label">Active Identity</div>
            </div>
            <div class="stat-card">
                <div class="number" id="identityLimit">0/3</div>
                <div class="label">Plan Limit</div>
            </div>
            <div class="stat-card">
                <div class="number" id="monthlyUsage">0 GB</div>
                <div class="label">Monthly Usage</div>
            </div>
        </div>
        
        <!-- Identities Grid -->
        <div class="identities-grid" id="identitiesGrid">
            <div class="empty-state">
                <div class="icon">&#x1F465;</div>
                <h3>Loading identities...</h3>
                <p><span class="loading-spinner"></span></p>
            </div>
        </div>
    </main>
    
    <!-- Create Identity Modal -->
    <div class="modal" id="createModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>&#x2795; Create Regional Identity</h2>
                <button class="modal-close" onclick="hideModal()">&times;</button>
            </div>
            <form id="createForm" onsubmit="createIdentity(event)">
                <div class="form-group">
                    <label>Identity Name *</label>
                    <input type="text" name="name" id="identityName" placeholder="e.g., US Banking, UK Shopping" required>
                </div>
                
                <label style="display:block;margin-bottom:10px">Select Region *</label>
                <div class="region-selector" id="regionSelector">
                    <!-- Regions loaded dynamically based on available servers -->
                </div>
                <input type="hidden" name="region" id="selectedRegion">
                
                <div class="form-group" style="margin-top:20px">
                    <label>Description (optional)</label>
                    <input type="text" name="description" id="identityDescription" placeholder="What will you use this identity for?">
                </div>
                
                <div style="display:flex;gap:10px;margin-top:25px">
                    <button type="button" class="btn btn-secondary" onclick="hideModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex:1" id="createBtn">&#x2795; Create Identity</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Identity Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>&#x270F; Edit Identity</h2>
                <button class="modal-close" onclick="hideEditModal()">&times;</button>
            </div>
            <form id="editForm" onsubmit="saveIdentity(event)">
                <input type="hidden" name="id" id="editIdentityId">
                <div class="form-group">
                    <label>Identity Name *</label>
                    <input type="text" name="name" id="editIdentityName" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" name="description" id="editIdentityDescription">
                </div>
                <div style="display:flex;gap:10px;margin-top:25px">
                    <button type="button" class="btn btn-secondary" onclick="hideEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex:1">&#x1F4BE; Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="/assets/js/theme-loader.js"></script>
    <script src="/assets/js/app.js"></script>
    <script>
        // Check authentication
        if (!TrueVault.Auth.requireAuth()) {
            // Will redirect to login
        }
        
        // State
        let identities = [];
        let availableRegions = [];
        let userPlan = { max_identities: 3 };
        
        // Country flag mapping using HTML entities
        const FLAGS = {
            'US': '&#x1F1FA;&#x1F1F8;',
            'CA': '&#x1F1E8;&#x1F1E6;',
            'UK': '&#x1F1EC;&#x1F1E7;',
            'GB': '&#x1F1EC;&#x1F1E7;',
            'DE': '&#x1F1E9;&#x1F1EA;',
            'FR': '&#x1F1EB;&#x1F1F7;',
            'AU': '&#x1F1E6;&#x1F1FA;',
            'JP': '&#x1F1EF;&#x1F1F5;',
            'SG': '&#x1F1F8;&#x1F1EC;',
            'NL': '&#x1F1F3;&#x1F1F1;'
        };
        
        const REGION_NAMES = {
            'US': 'United States',
            'CA': 'Canada',
            'UK': 'United Kingdom',
            'GB': 'United Kingdom',
            'DE': 'Germany',
            'FR': 'France',
            'AU': 'Australia',
            'JP': 'Japan',
            'SG': 'Singapore',
            'NL': 'Netherlands'
        };
        
        const TIMEZONES = {
            'US': 'America/New_York',
            'CA': 'America/Toronto',
            'UK': 'Europe/London',
            'GB': 'Europe/London',
            'DE': 'Europe/Berlin',
            'FR': 'Europe/Paris',
            'AU': 'Australia/Sydney',
            'JP': 'Asia/Tokyo',
            'SG': 'Asia/Singapore',
            'NL': 'Europe/Amsterdam'
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await loadUserInfo();
            await loadAvailableRegions();
            await loadIdentities();
        });
        
        // Load user info
        async function loadUserInfo() {
            const user = TrueVault.Auth.getUser();
            if (user) {
                document.getElementById('userName').textContent = user.first_name + ' ' + user.last_name;
                document.getElementById('userPlan').textContent = (user.plan_type || 'personal').charAt(0).toUpperCase() + (user.plan_type || 'personal').slice(1) + ' Plan';
                
                // Set identity limits based on plan
                const limits = {
                    'personal': 3,
                    'family': 10,
                    'business': 50,
                    'vip': 999
                };
                userPlan.max_identities = limits[user.plan_type] || 3;
            }
        }
        
        // Load available regions from servers
        async function loadAvailableRegions() {
            try {
                const response = await TrueVault.API.get('/vpn/servers.php');
                if (response.success && response.data) {
                    // Extract unique countries from servers
                    const countries = new Set();
                    response.data.forEach(server => {
                        if (server.country) {
                            countries.add(server.country.toUpperCase());
                        }
                    });
                    availableRegions = Array.from(countries);
                    renderRegionSelector();
                }
            } catch (error) {
                console.error('Failed to load regions:', error);
                // Default regions if API fails
                availableRegions = ['US', 'CA'];
                renderRegionSelector();
            }
        }
        
        // Render region selector in modal
        function renderRegionSelector() {
            const container = document.getElementById('regionSelector');
            const allRegions = ['US', 'CA', 'UK', 'DE', 'FR', 'AU'];
            
            container.innerHTML = allRegions.map(region => {
                const isAvailable = availableRegions.includes(region);
                return `
                    <div class="region-option ${isAvailable ? '' : 'disabled'}" 
                         data-region="${region}" 
                         onclick="${isAvailable ? 'selectRegion(this)' : ''}">
                        <div class="flag">${FLAGS[region] || '&#x1F3F3;'}</div>
                        <div>${REGION_NAMES[region] || region}</div>
                        ${!isAvailable ? '<small style="color:var(--colors-text-muted)">(No server)</small>' : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Load identities from API
        async function loadIdentities() {
            const grid = document.getElementById('identitiesGrid');
            
            try {
                const response = await TrueVault.API.get('/identities/index.php');
                
                if (response.success) {
                    identities = response.data || [];
                    renderIdentities();
                    updateStats();
                } else {
                    // No identities yet
                    identities = [];
                    renderIdentities();
                    updateStats();
                }
            } catch (error) {
                console.error('Failed to load identities:', error);
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">&#x26A0;</div>
                        <h3>Failed to load identities</h3>
                        <p>${error.message || 'Please try again'}</p>
                        <button class="btn btn-primary" onclick="loadIdentities()" style="margin-top:15px">&#x1F504; Retry</button>
                    </div>
                `;
            }
        }
        
        // Update stats display
        function updateStats() {
            const activeIdentity = identities.find(i => i.is_active);
            const totalUsage = identities.reduce((sum, i) => sum + (parseFloat(i.usage_gb) || 0), 0);
            
            document.getElementById('totalIdentities').textContent = identities.length;
            document.getElementById('activeIdentity').textContent = activeIdentity ? activeIdentity.name : 'None';
            document.getElementById('identityLimit').textContent = `${identities.length}/${userPlan.max_identities}`;
            document.getElementById('monthlyUsage').textContent = totalUsage.toFixed(1) + ' GB';
        }
        
        // Render identities grid
        function renderIdentities() {
            const grid = document.getElementById('identitiesGrid');
            
            if (identities.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1">
                        <div class="icon">&#x1F465;</div>
                        <h3>No Identities Yet</h3>
                        <p>Create your first regional identity to get started</p>
                        <button class="btn btn-primary" onclick="showCreateModal()" style="margin-top:15px">&#x2795; Create Identity</button>
                    </div>
                `;
                return;
            }
            
            let html = identities.map(identity => {
                const isActive = identity.is_active == 1;
                const usagePercent = Math.min(100, ((parseFloat(identity.usage_gb) || 0) / 50) * 100);
                const flag = FLAGS[identity.region] || '&#x1F3F3;';
                const regionName = REGION_NAMES[identity.region] || identity.region;
                const timezone = TIMEZONES[identity.region] || 'UTC';
                
                return `
                    <div class="identity-card ${isActive ? 'active' : ''}">
                        <div class="identity-header">
                            <span class="identity-flag">${flag}</span>
                            <div class="identity-info">
                                <h3>${escapeHtml(identity.name)}</h3>
                                <div class="region">${regionName} ${isActive ? '&#x2022; Primary' : ''}</div>
                            </div>
                            ${isActive ? '<span class="badge badge-success">Active</span>' : ''}
                        </div>
                        <div class="identity-details">
                            <div class="identity-detail">
                                <span class="identity-detail-label">Persistent IP</span>
                                <span class="identity-detail-value">${identity.assigned_ip || 'Auto-assigned'}</span>
                            </div>
                            <div class="identity-detail">
                                <span class="identity-detail-label">Timezone</span>
                                <span class="identity-detail-value">${timezone}</span>
                            </div>
                            <div class="identity-detail">
                                <span class="identity-detail-label">Browser Fingerprint</span>
                                <span class="identity-detail-value">${identity.fingerprint_hash ? 'Consistent &#x2705;' : 'Pending'}</span>
                            </div>
                            <div class="identity-detail">
                                <span class="identity-detail-label">Created</span>
                                <span class="identity-detail-value">${formatDate(identity.created_at)}</span>
                            </div>
                            ${identity.usage_gb ? `
                            <div class="usage-info">
                                <div style="display:flex;justify-content:space-between;font-size:0.85rem">
                                    <span>Usage this month</span>
                                    <span>${(parseFloat(identity.usage_gb) || 0).toFixed(1)} GB / 50 GB</span>
                                </div>
                                <div class="usage-bar"><div class="usage-fill" style="width:${usagePercent}%"></div></div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="identity-actions">
                            ${!isActive ? `<button class="btn btn-primary btn-small" onclick="activateIdentity(${identity.id})">&#x26A1; Use This</button>` : ''}
                            <button class="btn btn-secondary btn-small" onclick="editIdentity(${identity.id})">&#x270F;</button>
                            <button class="btn btn-danger btn-small" onclick="deleteIdentity(${identity.id})">&#x1F5D1;</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add create card if under limit
            if (identities.length < userPlan.max_identities) {
                html += `
                    <div class="create-identity" onclick="showCreateModal()">
                        <div class="icon">&#x2795;</div>
                        <h3>Create New Identity</h3>
                        <p class="text-muted">Add a new regional persona</p>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }
        
        // Show create modal
        function showCreateModal() {
            if (identities.length >= userPlan.max_identities) {
                TrueVault.Toast.error(`You've reached your limit of ${userPlan.max_identities} identities. Upgrade your plan for more.`);
                return;
            }
            document.getElementById('createForm').reset();
            document.querySelectorAll('.region-option').forEach(o => o.classList.remove('selected'));
            document.getElementById('selectedRegion').value = '';
            document.getElementById('createModal').classList.add('active');
        }
        
        function hideModal() {
            document.getElementById('createModal').classList.remove('active');
        }
        
        // Select region
        function selectRegion(el) {
            if (el.classList.contains('disabled')) return;
            document.querySelectorAll('.region-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('selectedRegion').value = el.dataset.region;
        }
        
        // Create identity
        async function createIdentity(e) {
            e.preventDefault();
            
            const name = document.getElementById('identityName').value.trim();
            const region = document.getElementById('selectedRegion').value;
            const description = document.getElementById('identityDescription').value.trim();
            
            if (!name) {
                TrueVault.Toast.error('Please enter a name for this identity');
                return;
            }
            
            if (!region) {
                TrueVault.Toast.error('Please select a region');
                return;
            }
            
            const btn = document.getElementById('createBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Creating...';
            
            try {
                const response = await TrueVault.API.post('/identities/index.php', {
                    action: 'create',
                    name: name,
                    region: region,
                    description: description
                });
                
                if (response.success) {
                    TrueVault.Toast.success('Identity created successfully!');
                    hideModal();
                    await loadIdentities();
                } else {
                    TrueVault.Toast.error(response.error || 'Failed to create identity');
                }
            } catch (error) {
                TrueVault.Toast.error(error.message || 'Failed to create identity');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '&#x2795; Create Identity';
            }
        }
        
        // Activate identity
        async function activateIdentity(id) {
            try {
                const response = await TrueVault.API.post('/identities/index.php', {
                    action: 'activate',
                    id: id
                });
                
                if (response.success) {
                    TrueVault.Toast.success('Identity activated!');
                    await loadIdentities();
                } else {
                    TrueVault.Toast.error(response.error || 'Failed to activate identity');
                }
            } catch (error) {
                TrueVault.Toast.error(error.message || 'Failed to activate identity');
            }
        }
        
        // Edit identity
        function editIdentity(id) {
            const identity = identities.find(i => i.id == id);
            if (!identity) return;
            
            document.getElementById('editIdentityId').value = id;
            document.getElementById('editIdentityName').value = identity.name;
            document.getElementById('editIdentityDescription').value = identity.description || '';
            document.getElementById('editModal').classList.add('active');
        }
        
        function hideEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }
        
        // Save identity
        async function saveIdentity(e) {
            e.preventDefault();
            
            const id = document.getElementById('editIdentityId').value;
            const name = document.getElementById('editIdentityName').value.trim();
            const description = document.getElementById('editIdentityDescription').value.trim();
            
            if (!name) {
                TrueVault.Toast.error('Name is required');
                return;
            }
            
            try {
                const response = await TrueVault.API.post('/identities/index.php', {
                    action: 'update',
                    id: id,
                    name: name,
                    description: description
                });
                
                if (response.success) {
                    TrueVault.Toast.success('Identity updated!');
                    hideEditModal();
                    await loadIdentities();
                } else {
                    TrueVault.Toast.error(response.error || 'Failed to update identity');
                }
            } catch (error) {
                TrueVault.Toast.error(error.message || 'Failed to update identity');
            }
        }
        
        // Delete identity
        async function deleteIdentity(id) {
            const identity = identities.find(i => i.id == id);
            if (!identity) return;
            
            if (!confirm(`Delete identity "${identity.name}"? This cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await TrueVault.API.post('/identities/index.php', {
                    action: 'delete',
                    id: id
                });
                
                if (response.success) {
                    TrueVault.Toast.success('Identity deleted');
                    await loadIdentities();
                } else {
                    TrueVault.Toast.error(response.error || 'Failed to delete identity');
                }
            } catch (error) {
                TrueVault.Toast.error(error.message || 'Failed to delete identity');
            }
        }
        
        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'Unknown';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        // Modal click outside to close
        document.getElementById('createModal').addEventListener('click', function(e) {
            if (e.target === this) hideModal();
        });
        
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) hideEditModal();
        });
    </script>
</body>
</html>
