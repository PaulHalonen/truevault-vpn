<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesh Network - TrueVault VPN</title>
    <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style id="theme-variables">:root{--colors-primary:#00d9ff;--colors-secondary:#00ff88;--colors-accent:#ff6b6b;--colors-background:#0f0f1a;--colors-background-secondary:#1a1a2e;--colors-text:#ffffff;--colors-text-muted:#888888;--colors-success:#00ff88;--colors-warning:#ffbb00;--colors-error:#ff5050;--gradients-primary:linear-gradient(90deg,#00d9ff,#00ff88);--gradients-background:linear-gradient(135deg,#0f0f1a,#1a1a2e);--buttons-border-radius:8px;--cards-border-radius:14px;--colors-border:rgba(255,255,255,0.08);--layout-sidebar-width:260px;}</style>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/dashboard.css">
    <style>
        .mesh-intro{background:linear-gradient(135deg,rgba(138,43,226,0.15),rgba(0,217,255,0.1));border:1px solid rgba(138,43,226,0.3);border-radius:var(--cards-border-radius);padding:30px;margin-bottom:30px}
        .mesh-intro h2{margin-bottom:10px;color:#9b59b6}
        .stats-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:15px;margin-bottom:25px}
        .stat-card{background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:10px;padding:20px;text-align:center}
        .stat-card .number{font-size:1.8rem;font-weight:700;background:linear-gradient(90deg,var(--colors-primary),var(--colors-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .stat-card .label{color:var(--colors-text-muted);font-size:0.85rem;margin-top:5px}
        .members-section{margin-bottom:30px}
        .members-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px;margin-top:15px}
        .member-card{background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:var(--cards-border-radius);padding:20px;display:flex;align-items:center;gap:15px}
        .member-card.pending{border-style:dashed;opacity:0.7}
        .member-avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#9b59b6,#00d9ff);display:flex;align-items:center;justify-content:center;font-size:1.5rem}
        .member-info{flex:1}
        .member-info h4{margin-bottom:3px}
        .member-info .email{font-size:0.85rem;color:var(--colors-text-muted)}
        .member-info .status{font-size:0.8rem;margin-top:5px}
        .shared-resources{margin-top:30px}
        .resource-card{background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:12px;padding:20px;display:flex;align-items:center;gap:15px;margin-bottom:10px}
        .resource-icon{font-size:2rem}
        .resource-info{flex:1}
        .resource-info h4{margin-bottom:3px}
        .resource-info p{font-size:0.85rem;color:var(--colors-text-muted)}
        .invite-section{background:rgba(138,43,226,0.1);border:1px solid rgba(138,43,226,0.3);border-radius:var(--cards-border-radius);padding:25px;margin-top:30px}
        .invite-form{display:flex;gap:10px;margin-top:15px}
        .invite-form input{flex:1}
        .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s}
        .modal.active{opacity:1;visibility:visible}
        .modal-content{background:var(--colors-background-secondary);border:1px solid var(--colors-border);border-radius:var(--cards-border-radius);padding:30px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px}
        .modal-close{background:none;border:none;color:var(--colors-text-muted);font-size:1.5rem;cursor:pointer}
        .empty-state{text-align:center;padding:40px;background:rgba(255,255,255,0.02);border-radius:var(--cards-border-radius);border:1px dashed var(--colors-border)}
        .loading-spinner{display:inline-block;width:20px;height:20px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:var(--colors-primary);animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body class="dashboard-body">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><span class="logo-icon">&#x1F6E1;</span><h1>TrueVault</h1></div>
        <nav class="sidebar-nav">
            <a href="/dashboard/" class="nav-item"><span class="nav-icon">&#x1F4CA;</span><span>Overview</span></a>
            <a href="/dashboard/connect.html" class="nav-item"><span class="nav-icon">&#x26A1;</span><span>Connect</span></a>
            <a href="/dashboard/servers.html" class="nav-item"><span class="nav-icon">&#x1F5A5;</span><span>Servers</span></a>
            <a href="/dashboard/identities.html" class="nav-item"><span class="nav-icon">&#x1F465;</span><span>Identities</span></a>
            <a href="/dashboard/certificates.html" class="nav-item"><span class="nav-icon">&#x1F4DC;</span><span>Certificates</span></a>
            <a href="/dashboard/devices.html" class="nav-item"><span class="nav-icon">&#x1F4F1;</span><span>Devices</span></a>
            <a href="/dashboard/cameras.html" class="nav-item"><span class="nav-icon">&#x1F4F7;</span><span>Cameras</span></a>
            <a href="/dashboard/mesh.html" class="nav-item active"><span class="nav-icon">&#x1F578;</span><span>Mesh Network</span></a>
            <div class="nav-divider"></div>
            <a href="/dashboard/scanner.html" class="nav-item"><span class="nav-icon">&#x1F4E1;</span><span>Network Scanner</span></a>
            <a href="/dashboard/settings.html" class="nav-item"><span class="nav-icon">&#x2699;</span><span>Settings</span></a>
            <a href="/dashboard/billing.html" class="nav-item"><span class="nav-icon">&#x1F4B3;</span><span>Billing</span></a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info"><div class="user-avatar">&#x1F464;</div><div class="user-details"><span class="user-name" id="userName">Loading...</span><span class="user-plan" id="userPlan">-</span></div></div>
            <button class="btn btn-secondary btn-small" onclick="TrueVault.Auth.logout()">Logout</button>
        </div>
    </aside>
    
    <main class="main-content">
        <header class="dashboard-header">
            <div>
                <h1>&#x1F578; Family Mesh Network</h1>
                <p class="text-muted">Connect devices across locations as if they're on the same network</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="showInviteModal()">&#x2795; Invite Member</button>
            </div>
        </header>
        
        <div class="mesh-intro">
            <h2>&#x1F310; Your Private Overlay Network</h2>
            <p class="text-muted">Connect all your devices and trusted family members as if they're on the same local network - regardless of physical location. Share printers, access cameras, transfer files, and more without complex port forwarding.</p>
        </div>
        
        <div class="stats-bar">
            <div class="stat-card"><div class="number" id="memberCount">0</div><div class="label">Members</div></div>
            <div class="stat-card"><div class="number" id="onlineCount">0</div><div class="label">Online</div></div>
            <div class="stat-card"><div class="number" id="deviceCount">0</div><div class="label">Devices</div></div>
            <div class="stat-card"><div class="number" id="resourceCount">0</div><div class="label">Shared Resources</div></div>
        </div>
        
        <div class="members-section">
            <h3>&#x1F465; Network Members</h3>
            <div class="members-grid" id="membersGrid">
                <div class="loading"><span class="loading-spinner"></span> Loading members...</div>
            </div>
        </div>
        
        <div class="shared-resources">
            <h3>&#x1F4C1; Shared Resources</h3>
            <div id="resourcesContainer">
                <div class="loading"><span class="loading-spinner"></span> Loading resources...</div>
            </div>
        </div>
        
        <div class="invite-section">
            <h3>&#x2709; Invite Family Members</h3>
            <p class="text-muted">Members you invite can connect to your mesh network and access shared resources.</p>
            <form class="invite-form" onsubmit="sendInvite(event)">
                <input type="email" id="inviteEmail" placeholder="Enter email address" required>
                <button type="submit" class="btn btn-primary" id="inviteBtn">Send Invite</button>
            </form>
        </div>
    </main>
    
    <div class="modal" id="inviteModal">
        <div class="modal-content">
            <div class="modal-header"><h2>&#x2795; Invite Member</h2><button class="modal-close" onclick="hideInviteModal()">&times;</button></div>
            <form onsubmit="sendInviteFromModal(event)">
                <div class="form-group"><label>Email Address *</label><input type="email" id="modalInviteEmail" required></div>
                <div class="form-group"><label>Permission Level</label><select id="permissionLevel"><option value="viewer">Viewer - Can view shared resources</option><option value="member">Member - Can view and use resources</option><option value="admin">Admin - Full access</option></select></div>
                <div style="display:flex;gap:10px;margin-top:25px"><button type="button" class="btn btn-secondary" onclick="hideInviteModal()">Cancel</button><button type="submit" class="btn btn-primary" style="flex:1">&#x2709; Send Invitation</button></div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="memberModal">
        <div class="modal-content">
            <div class="modal-header"><h2>&#x1F464; Member Settings</h2><button class="modal-close" onclick="hideMemberModal()">&times;</button></div>
            <div id="memberDetails"></div>
        </div>
    </div>
    
    <script src="/assets/js/theme-loader.js"></script>
    <script src="/assets/js/app.js"></script>
    <script>
        if (!TrueVault.Auth.requireAuth()) {}
        
        let members = [];
        let resources = [];
        let currentMemberId = null;
        
        document.addEventListener('DOMContentLoaded', async function() {
            await loadUserInfo();
            await loadMeshData();
        });
        
        async function loadUserInfo() {
            const user = TrueVault.Auth.getUser();
            if (user) {
                document.getElementById('userName').textContent = user.first_name + ' ' + user.last_name;
                document.getElementById('userPlan').textContent = (user.plan_type || 'personal').charAt(0).toUpperCase() + (user.plan_type || 'personal').slice(1) + ' Plan';
            }
        }
        
        async function loadMeshData() {
            try {
                const result = await TrueVault.API.get('/mesh/index.php');
                if (result.success) {
                    members = result.data.members || [];
                    resources = result.data.resources || [];
                    updateStats();
                    renderMembers();
                    renderResources();
                } else {
                    document.getElementById('membersGrid').innerHTML = '<p class="text-error">Failed to load mesh data</p>';
                }
            } catch (error) {
                document.getElementById('membersGrid').innerHTML = '<p class="text-error">Failed to load mesh data</p>';
            }
        }
        
        function updateStats() {
            const online = members.filter(m => m.is_online).length;
            const devices = members.reduce((sum, m) => sum + (parseInt(m.device_count) || 0), 0);
            document.getElementById('memberCount').textContent = members.length;
            document.getElementById('onlineCount').textContent = online;
            document.getElementById('deviceCount').textContent = devices;
            document.getElementById('resourceCount').textContent = resources.length;
        }
        
        function renderMembers() {
            const grid = document.getElementById('membersGrid');
            if (members.length === 0) {
                grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div style="font-size:3rem;opacity:0.3;margin-bottom:15px">&#x1F465;</div><h3>No Members Yet</h3><p class="text-muted">Invite family members to join your mesh network</p></div>';
                return;
            }
            grid.innerHTML = members.map(renderMember).join('');
        }
        
        function renderMember(member) {
            const statusBadge = member.status === 'pending' ? '<span class="badge badge-warning">Pending</span>' : (member.is_online ? '<span class="badge badge-success">Online</span>' : '<span class="badge badge-info">Offline</span>');
            const isOwner = member.role === 'owner';
            return '<div class="member-card' + (member.status === 'pending' ? ' pending' : '') + '"><div class="member-avatar">&#x1F464;</div><div class="member-info"><h4>' + escapeHtml(member.name || member.email) + (isOwner ? ' (Owner)' : '') + '</h4><div class="email">' + escapeHtml(member.email) + '</div><div class="status">' + statusBadge + (member.device_count ? ' &#x2022; ' + member.device_count + ' devices' : '') + '</div></div>' + (!isOwner ? '<button class="btn btn-secondary btn-small" onclick="manageMember(' + member.id + ')">&#x2699;</button>' : '') + '</div>';
        }
        
        function renderResources() {
            const container = document.getElementById('resourcesContainer');
            if (resources.length === 0) {
                container.innerHTML = '<div class="empty-state"><div style="font-size:3rem;opacity:0.3;margin-bottom:15px">&#x1F4C1;</div><h3>No Shared Resources</h3><p class="text-muted">Add devices from your network to share with members</p><button class="btn btn-primary" onclick="showShareResourceModal()" style="margin-top:15px">&#x2795; Share Resource</button></div>';
                return;
            }
            container.innerHTML = resources.map(renderResource).join('');
        }
        
        function renderResource(resource) {
            const icons = { printer: '&#x1F5A8;', camera: '&#x1F4F7;', nas: '&#x1F4BE;', server: '&#x1F5A5;', other: '&#x1F4E6;' };
            const icon = icons[resource.type] || icons.other;
            return '<div class="resource-card"><span class="resource-icon">' + icon + '</span><div class="resource-info"><h4>' + escapeHtml(resource.name) + '</h4><p>Shared by ' + escapeHtml(resource.shared_by || 'You') + ' &#x2022; ' + escapeHtml(resource.access_level || 'Full access') + '</p></div><button class="btn btn-secondary btn-small" onclick="manageResource(' + resource.id + ')">&#x2699;</button></div>';
        }
        
        function showInviteModal() { document.getElementById('modalInviteEmail').value = ''; document.getElementById('inviteModal').classList.add('active'); }
        function hideInviteModal() { document.getElementById('inviteModal').classList.remove('active'); }
        function hideMemberModal() { document.getElementById('memberModal').classList.remove('active'); }
        
        async function sendInvite(e) {
            e.preventDefault();
            const email = document.getElementById('inviteEmail').value.trim();
            if (!email) return;
            const btn = document.getElementById('inviteBtn');
            btn.disabled = true; btn.innerHTML = '<span class="loading-spinner"></span>';
            try {
                const result = await TrueVault.API.post('/mesh/invite.php', { email: email, permission: 'member' });
                if (result.success) { TrueVault.Toast.success('Invitation sent to ' + email); document.getElementById('inviteEmail').value = ''; await loadMeshData(); }
                else { TrueVault.Toast.error(result.error || 'Failed to send invitation'); }
            } catch (error) { TrueVault.Toast.error('Failed to send invitation'); }
            finally { btn.disabled = false; btn.textContent = 'Send Invite'; }
        }
        
        async function sendInviteFromModal(e) {
            e.preventDefault();
            const email = document.getElementById('modalInviteEmail').value.trim();
            const permission = document.getElementById('permissionLevel').value;
            if (!email) return;
            try {
                const result = await TrueVault.API.post('/mesh/invite.php', { email: email, permission: permission });
                if (result.success) { TrueVault.Toast.success('Invitation sent!'); hideInviteModal(); await loadMeshData(); }
                else { TrueVault.Toast.error(result.error || 'Failed to send invitation'); }
            } catch (error) { TrueVault.Toast.error('Failed to send invitation'); }
        }
        
        function manageMember(id) {
            const member = members.find(m => m.id === id);
            if (!member) return;
            currentMemberId = id;
            document.getElementById('memberDetails').innerHTML = '<div style="padding:20px;background:rgba(0,0,0,0.2);border-radius:10px;margin-bottom:20px"><div style="display:flex;align-items:center;gap:15px;margin-bottom:15px"><div class="member-avatar">&#x1F464;</div><div><h3>' + escapeHtml(member.name || member.email) + '</h3><p class="text-muted">' + escapeHtml(member.email) + '</p></div></div><div style="display:grid;gap:10px"><div style="display:flex;justify-content:space-between"><span>Status</span><span>' + (member.is_online ? '&#x2705; Online' : '&#x274C; Offline') + '</span></div><div style="display:flex;justify-content:space-between"><span>Devices</span><span>' + (member.device_count || 0) + '</span></div><div style="display:flex;justify-content:space-between"><span>Permission</span><span>' + escapeHtml(member.permission || 'Member') + '</span></div></div></div><div class="form-group"><label>Permission Level</label><select id="memberPermission"><option value="viewer"' + (member.permission === 'viewer' ? ' selected' : '') + '>Viewer</option><option value="member"' + (member.permission === 'member' ? ' selected' : '') + '>Member</option><option value="admin"' + (member.permission === 'admin' ? ' selected' : '') + '>Admin</option></select></div><div style="display:flex;gap:10px;margin-top:20px"><button class="btn btn-secondary" onclick="hideMemberModal()">Cancel</button><button class="btn btn-primary" style="flex:1" onclick="saveMember()">Save Changes</button><button class="btn btn-danger" onclick="removeMember(' + id + ')">Remove</button></div>';
            document.getElementById('memberModal').classList.add('active');
        }
        
        async function saveMember() {
            if (!currentMemberId) return;
            const permission = document.getElementById('memberPermission').value;
            try {
                const result = await TrueVault.API.post('/mesh/members.php', { action: 'update', id: currentMemberId, permission: permission });
                if (result.success) { TrueVault.Toast.success('Member updated'); hideMemberModal(); await loadMeshData(); }
                else { TrueVault.Toast.error(result.error || 'Failed to update'); }
            } catch (error) { TrueVault.Toast.error('Failed to update'); }
        }
        
        async function removeMember(id) {
            if (!confirm('Remove this member from your mesh network?')) return;
            try {
                const result = await TrueVault.API.post('/mesh/members.php', { action: 'remove', id: id });
                if (result.success) { TrueVault.Toast.success('Member removed'); hideMemberModal(); await loadMeshData(); }
                else { TrueVault.Toast.error(result.error || 'Failed to remove'); }
            } catch (error) { TrueVault.Toast.error('Failed to remove'); }
        }
        
        function manageResource(id) { TrueVault.Toast.info('Resource settings - feature in development'); }
        function showShareResourceModal() { TrueVault.Toast.info('Share resource - feature in development'); }
        
        function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        
        document.getElementById('inviteModal').addEventListener('click', function(e) { if (e.target === this) hideInviteModal(); });
        document.getElementById('memberModal').addEventListener('click', function(e) { if (e.target === this) hideMemberModal(); });
    </script>
</body>
</html>
