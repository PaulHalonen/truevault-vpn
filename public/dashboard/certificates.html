<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificates - TrueVault VPN</title>
    <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style id="theme-variables">:root{--colors-primary:#00d9ff;--colors-secondary:#00ff88;--colors-accent:#ff6b6b;--colors-background:#0f0f1a;--colors-background-secondary:#1a1a2e;--colors-text:#ffffff;--colors-text-muted:#888888;--colors-success:#00ff88;--colors-warning:#ffbb00;--colors-error:#ff5050;--gradients-primary:linear-gradient(90deg,#00d9ff,#00ff88);--gradients-background:linear-gradient(135deg,#0f0f1a,#1a1a2e);--buttons-border-radius:8px;--cards-border-radius:14px;--colors-border:rgba(255,255,255,0.08);--layout-sidebar-width:260px;}</style>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/dashboard.css">
    <style>
        .ca-card{background:linear-gradient(135deg,rgba(0,217,255,0.1),rgba(0,255,136,0.1));border:1px solid rgba(0,217,255,0.3);border-radius:var(--cards-border-radius);padding:30px;margin-bottom:30px}
        .ca-card.no-ca{border-color:var(--colors-warning);background:rgba(255,187,0,0.1)}
        .ca-header{display:flex;align-items:center;gap:20px;margin-bottom:20px}
        .ca-icon{font-size:3rem}
        .ca-info h2{font-size:1.5rem;margin-bottom:5px}
        .ca-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px}
        .ca-detail{background:rgba(0,0,0,0.2);padding:15px;border-radius:10px}
        .ca-detail-label{font-size:0.8rem;color:var(--colors-text-muted);margin-bottom:5px}
        .ca-detail-value{font-size:1rem;font-family:monospace}
        .certs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
        .cert-card{background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:var(--cards-border-radius);padding:20px}
        .cert-card.expiring{border-color:var(--colors-warning)}
        .cert-card.expired{border-color:var(--colors-error)}
        .cert-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:15px}
        .cert-type{padding:4px 10px;border-radius:15px;font-size:0.75rem;font-weight:600}
        .cert-type.root{background:rgba(0,217,255,0.2);color:var(--colors-primary)}
        .cert-type.device{background:rgba(0,255,136,0.2);color:var(--colors-secondary)}
        .cert-type.regional{background:rgba(255,187,0,0.2);color:var(--colors-warning)}
        .cert-type.mesh{background:rgba(138,43,226,0.2);color:#9b59b6}
        .cert-name{font-size:1.1rem;font-weight:600;margin-bottom:5px}
        .cert-serial{font-family:monospace;font-size:0.8rem;color:var(--colors-text-muted)}
        .cert-dates{display:flex;gap:20px;margin:15px 0;padding:15px 0;border-top:1px solid var(--colors-border);border-bottom:1px solid var(--colors-border)}
        .cert-date{flex:1}
        .cert-date-label{font-size:0.75rem;color:var(--colors-text-muted)}
        .cert-date-value{font-size:0.9rem;margin-top:3px}
        .cert-actions{display:flex;gap:8px}
        .generate-section{margin-top:30px}
        .generate-options{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px;margin-top:20px}
        .generate-option{background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s}
        .generate-option:hover{border-color:var(--colors-primary);background:rgba(255,255,255,0.05)}
        .generate-option .icon{font-size:2rem;margin-bottom:10px}
        .generate-option h4{margin-bottom:5px}
        .generate-option p{font-size:0.8rem;color:var(--colors-text-muted)}
        .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s}
        .modal.active{opacity:1;visibility:visible}
        .modal-content{background:var(--colors-background-secondary);border:1px solid var(--colors-border);border-radius:var(--cards-border-radius);padding:30px;width:100%;max-width:500px}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px}
        .modal-close{background:none;border:none;color:var(--colors-text-muted);font-size:1.5rem;cursor:pointer}
        .cert-details-modal{max-width:600px}
        .cert-detail-row{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--colors-border)}
        .cert-detail-row:last-child{border-bottom:none}
        .cert-detail-label{color:var(--colors-text-muted)}
        .cert-detail-value{font-family:monospace;text-align:right;max-width:300px;word-break:break-all}
    </style>
</head>
<body class="dashboard-body">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><span class="logo-icon">&#128737;</span><h1>TrueVault</h1></div>
        <nav class="sidebar-nav">
            <a href="/dashboard/" class="nav-item"><span class="nav-icon">&#128200;</span><span>Overview</span></a>
            <a href="/dashboard/connect.html" class="nav-item"><span class="nav-icon">&#128279;</span><span>Connect</span></a>
            <a href="/dashboard/servers.html" class="nav-item"><span class="nav-icon">&#127760;</span><span>Servers</span></a>
            <a href="/dashboard/identities.html" class="nav-item"><span class="nav-icon">&#128100;</span><span>Identities</span></a>
            <a href="/dashboard/certificates.html" class="nav-item active"><span class="nav-icon">&#128274;</span><span>Certificates</span></a>
            <a href="/dashboard/devices.html" class="nav-item"><span class="nav-icon">&#128241;</span><span>Devices</span></a>
            <a href="/dashboard/cameras.html" class="nav-item"><span class="nav-icon">&#128247;</span><span>Cameras</span></a>
            <a href="/dashboard/mesh.html" class="nav-item"><span class="nav-icon">&#128279;</span><span>Mesh Network</span></a>
            <div class="nav-divider"></div>
            <a href="/dashboard/scanner.html" class="nav-item"><span class="nav-icon">&#128269;</span><span>Network Scanner</span></a>
            <a href="/dashboard/settings.html" class="nav-item"><span class="nav-icon">&#9881;</span><span>Settings</span></a>
            <a href="/dashboard/billing.html" class="nav-item"><span class="nav-icon">&#128179;</span><span>Billing</span></a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info"><div class="user-avatar">&#128100;</div><div class="user-details"><span class="user-name" id="userName">Loading...</span><span class="user-plan" id="userPlan">-</span></div></div>
            <button class="btn btn-secondary btn-small" onclick="TrueVault.Auth.logout()">Logout</button>
        </div>
    </aside>
    
    <main class="main-content">
        <header class="dashboard-header">
            <div>
                <h1>&#128274; Certificates</h1>
                <p class="text-muted">Your personal certificate authority and issued certificates</p>
            </div>
        </header>
        
        <!-- CA Status Card -->
        <div class="ca-card" id="caCard">
            <div class="ca-header">
                <span class="ca-icon" id="caIcon">&#128274;</span>
                <div class="ca-info">
                    <h2 id="caTitle">Loading...</h2>
                    <p class="text-muted" id="caSubtitle">Checking your certificate authority...</p>
                </div>
            </div>
            <div class="ca-details" id="caDetails"></div>
            <div id="caActions" style="margin-top:20px"></div>
        </div>
        
        <!-- Certificates Grid -->
        <h3 style="margin-bottom:20px">&#128196; Your Certificates</h3>
        <div class="certs-grid" id="certsGrid">
            <div class="loading">Loading certificates...</div>
        </div>
        
        <!-- Generate New Certificate -->
        <div class="generate-section">
            <h3>&#10133; Generate New Certificate</h3>
            <div class="generate-options">
                <div class="generate-option" onclick="showGenerateModal('device')">
                    <div class="icon">&#128241;</div>
                    <h4>Device Certificate</h4>
                    <p>Secure a new device</p>
                </div>
                <div class="generate-option" onclick="showGenerateModal('regional')">
                    <div class="icon">&#127760;</div>
                    <h4>Regional Identity</h4>
                    <p>Create regional persona</p>
                </div>
                <div class="generate-option" onclick="showGenerateModal('mesh')">
                    <div class="icon">&#128279;</div>
                    <h4>Mesh Certificate</h4>
                    <p>For family mesh network</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Generate Certificate Modal -->
    <div class="modal" id="generateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Generate Certificate</h2>
                <button class="modal-close" onclick="hideModal('generateModal')">&times;</button>
            </div>
            <form id="generateForm">
                <input type="hidden" name="type" id="certType">
                
                <div class="form-group">
                    <label>Certificate Name *</label>
                    <input type="text" name="name" id="certName" placeholder="e.g., My iPhone, US Banking, Family Network" required>
                </div>
                
                <div class="form-group" id="regionGroup" style="display:none">
                    <label>Region</label>
                    <select name="region_code" id="regionCode">
                        <option value="US">&#127482;&#127480; United States</option>
                        <option value="CA">&#127464;&#127462; Canada</option>
                        <option value="UK">&#127468;&#127463; United Kingdom</option>
                        <option value="DE">&#127465;&#127466; Germany</option>
                        <option value="FR">&#127467;&#127479; France</option>
                        <option value="AU">&#127462;&#127482; Australia</option>
                        <option value="JP">&#127471;&#127477; Japan</option>
                    </select>
                </div>
                
                <div style="display:flex;gap:10px;margin-top:25px">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('generateModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex:1">&#128274; Generate</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- View Certificate Modal -->
    <div class="modal" id="viewModal">
        <div class="modal-content cert-details-modal">
            <div class="modal-header">
                <h2>Certificate Details</h2>
                <button class="modal-close" onclick="hideModal('viewModal')">&times;</button>
            </div>
            <div id="certDetailsContent"></div>
            <div style="margin-top:20px;display:flex;gap:10px">
                <button class="btn btn-secondary" onclick="hideModal('viewModal')">Close</button>
                <button class="btn btn-primary" id="downloadFromViewBtn">&#128229; Download</button>
            </div>
        </div>
    </div>
    
    <script src="/assets/js/theme-loader.js"></script>
    <script src="/assets/js/app.js"></script>
    <script>
        if (!TrueVault.Auth.requireAuth()) {}
        
        let certificates = [];
        let hasCA = false;
        let caInfo = null;
        
        const user = TrueVault.Auth.getUser();
        if (user) {
            document.getElementById('userName').textContent = user.first_name + ' ' + user.last_name;
            document.getElementById('userPlan').textContent = user.plan_type.charAt(0).toUpperCase() + user.plan_type.slice(1) + ' Plan';
        }
        
        async function loadCertificates() {
            const result = await TrueVault.API.get('/certificates/index.php');
            
            if (result.success) {
                hasCA = result.data.has_ca;
                caInfo = result.data.ca_info;
                certificates = result.data.certificates || [];
                
                renderCA(caInfo);
                renderCertificates();
            } else {
                document.getElementById('caCard').innerHTML = '<p class="text-error">Failed to load certificates</p>';
            }
        }
        
        function renderCA(info) {
            const card = document.getElementById('caCard');
            const icon = document.getElementById('caIcon');
            const title = document.getElementById('caTitle');
            const subtitle = document.getElementById('caSubtitle');
            const details = document.getElementById('caDetails');
            const actions = document.getElementById('caActions');
            
            if (hasCA && info) {
                card.classList.remove('no-ca');
                icon.innerHTML = '&#128274;';
                title.textContent = 'Your Personal CA';
                subtitle.textContent = 'Your cryptographic identity is active and secure';
                
                details.innerHTML = `
                    <div class="ca-detail">
                        <div class="ca-detail-label">Serial Number</div>
                        <div class="ca-detail-value">${info.serial_number || 'N/A'}</div>
                    </div>
                    <div class="ca-detail">
                        <div class="ca-detail-label">Created</div>
                        <div class="ca-detail-value">${formatDate(info.created_at)}</div>
                    </div>
                    <div class="ca-detail">
                        <div class="ca-detail-label">Expires</div>
                        <div class="ca-detail-value">${formatDate(info.expires_at)}</div>
                    </div>
                    <div class="ca-detail">
                        <div class="ca-detail-label">Certificates Issued</div>
                        <div class="ca-detail-value">${certificates.length}</div>
                    </div>
                `;
                
                actions.innerHTML = `
                    <button class="btn btn-secondary" onclick="backupCA()">&#128229; Backup CA</button>
                    <button class="btn btn-secondary" onclick="exportCAPublicKey()" style="margin-left:10px">&#128273; Export Public Key</button>
                `;
            } else {
                card.classList.add('no-ca');
                icon.innerHTML = '&#9888;';
                title.textContent = 'No Certificate Authority';
                subtitle.textContent = 'Create your personal CA to start issuing certificates';
                details.innerHTML = '';
                actions.innerHTML = `
                    <button class="btn btn-primary btn-large" onclick="createCA()">&#128274; Create Your Certificate Authority</button>
                `;
            }
        }
        
        function renderCertificates() {
            const grid = document.getElementById('certsGrid');
            
            if (!hasCA) {
                grid.innerHTML = '<p class="text-muted">Create a Certificate Authority first to start issuing certificates.</p>';
                return;
            }
            
            if (certificates.length === 0) {
                grid.innerHTML = '<p class="text-muted">No certificates issued yet. Generate your first certificate below.</p>';
                return;
            }
            
            grid.innerHTML = certificates.map(cert => {
                const status = getCertStatus(cert);
                return `
                    <div class="cert-card ${status.class}">
                        <div class="cert-header">
                            <span class="cert-type ${cert.certificate_type}">${cert.certificate_type}</span>
                            <span class="badge badge-${status.badge}">${status.text}</span>
                        </div>
                        <div class="cert-name">${escapeHtml(cert.certificate_name)}</div>
                        <div class="cert-serial">Serial: ${cert.serial_number || 'N/A'}</div>
                        <div class="cert-dates">
                            <div class="cert-date">
                                <div class="cert-date-label">Issued</div>
                                <div class="cert-date-value">${formatDate(cert.issued_at || cert.created_at)}</div>
                            </div>
                            <div class="cert-date">
                                <div class="cert-date-label">Expires</div>
                                <div class="cert-date-value">${formatDate(cert.expires_at)}</div>
                            </div>
                        </div>
                        <div class="cert-actions">
                            <button class="btn btn-secondary btn-small" onclick="downloadCert(${cert.id})">&#128229; Download</button>
                            <button class="btn btn-secondary btn-small" onclick="viewCert(${cert.id})">&#128065; View</button>
                            ${cert.status !== 'revoked' ? `<button class="btn btn-danger btn-small" onclick="revokeCert(${cert.id})">&#10060; Revoke</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getCertStatus(cert) {
            if (cert.status === 'revoked') return { text: 'Revoked', badge: 'error', class: 'expired' };
            
            const now = new Date();
            const expires = new Date(cert.expires_at);
            const daysLeft = Math.ceil((expires - now) / (1000 * 60 * 60 * 24));
            
            if (daysLeft < 0) return { text: 'Expired', badge: 'error', class: 'expired' };
            if (daysLeft < 30) return { text: `${daysLeft}d left`, badge: 'warning', class: 'expiring' };
            return { text: 'Valid', badge: 'success', class: '' };
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        async function createCA() {
            if (!confirm('Create your Personal Certificate Authority? This will be your root of trust for all certificates.')) return;
            
            TrueVault.Toast.info('Creating your Certificate Authority...');
            
            const result = await TrueVault.API.post('/certificates/index.php', { 
                action: 'create_ca',
                type: 'root', 
                name: 'Personal Root CA' 
            });
            
            if (result.success) {
                TrueVault.Toast.success('Certificate Authority created successfully!');
                loadCertificates();
            } else {
                TrueVault.Toast.error(result.error || 'Failed to create CA');
            }
        }
        
        function showGenerateModal(type) {
            if (!hasCA) {
                TrueVault.Toast.error('Create a Certificate Authority first');
                return;
            }
            
            document.getElementById('certType').value = type;
            document.getElementById('certName').value = '';
            
            const titles = { 
                device: '&#128241; Device Certificate', 
                regional: '&#127760; Regional Identity', 
                mesh: '&#128279; Mesh Certificate' 
            };
            document.getElementById('modalTitle').innerHTML = titles[type] || 'Generate Certificate';
            
            document.getElementById('regionGroup').style.display = type === 'regional' ? 'block' : 'none';
            
            document.getElementById('generateModal').classList.add('active');
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        document.getElementById('generateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                action: 'generate',
                type: formData.get('type'),
                name: formData.get('name')
            };
            
            if (formData.get('type') === 'regional') {
                data.region_code = formData.get('region_code');
            }
            
            TrueVault.Toast.info('Generating certificate...');
            
            const result = await TrueVault.API.post('/certificates/index.php', data);
            
            if (result.success) {
                TrueVault.Toast.success('Certificate generated successfully!');
                hideModal('generateModal');
                loadCertificates();
            } else {
                TrueVault.Toast.error(result.error || 'Failed to generate certificate');
            }
        });
        
        async function downloadCert(id) {
            TrueVault.Toast.info('Preparing certificate download...');
            
            const result = await TrueVault.API.get(`/certificates/index.php?action=download&id=${id}`);
            
            if (result.success && result.data.certificate_data) {
                // Create downloadable file
                const blob = new Blob([result.data.certificate_data], { type: 'application/x-pem-file' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = result.data.filename || `certificate_${id}.pem`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                TrueVault.Toast.success('Certificate downloaded!');
            } else {
                TrueVault.Toast.error(result.error || 'Failed to download certificate');
            }
        }
        
        function viewCert(id) {
            const cert = certificates.find(c => c.id === id);
            if (!cert) {
                TrueVault.Toast.error('Certificate not found');
                return;
            }
            
            const status = getCertStatus(cert);
            
            document.getElementById('certDetailsContent').innerHTML = `
                <div class="cert-detail-row">
                    <span class="cert-detail-label">Name</span>
                    <span class="cert-detail-value">${escapeHtml(cert.certificate_name)}</span>
                </div>
                <div class="cert-detail-row">
                    <span class="cert-detail-label">Type</span>
                    <span class="cert-detail-value">${cert.certificate_type}</span>
                </div>
                <div class="cert-detail-row">
                    <span class="cert-detail-label">Serial Number</span>
                    <span class="cert-detail-value">${cert.serial_number || 'N/A'}</span>
                </div>
                <div class="cert-detail-row">
                    <span class="cert-detail-label">Status</span>
                    <span class="cert-detail-value"><span class="badge badge-${status.badge}">${status.text}</span></span>
                </div>
                <div class="cert-detail-row">
                    <span class="cert-detail-label">Issued</span>
                    <span class="cert-detail-value">${formatDate(cert.issued_at || cert.created_at)}</span>
                </div>
                <div class="cert-detail-row">
                    <span class="cert-detail-label">Expires</span>
                    <span class="cert-detail-value">${formatDate(cert.expires_at)}</span>
                </div>
                ${cert.region_code ? `
                <div class="cert-detail-row">
                    <span class="cert-detail-label">Region</span>
                    <span class="cert-detail-value">${cert.region_code}</span>
                </div>
                ` : ''}
                ${cert.fingerprint ? `
                <div class="cert-detail-row">
                    <span class="cert-detail-label">Fingerprint (SHA256)</span>
                    <span class="cert-detail-value" style="font-size:0.7rem">${cert.fingerprint}</span>
                </div>
                ` : ''}
            `;
            
            document.getElementById('downloadFromViewBtn').onclick = () => downloadCert(id);
            document.getElementById('viewModal').classList.add('active');
        }
        
        async function revokeCert(id) {
            const cert = certificates.find(c => c.id === id);
            if (!confirm(`Revoke certificate "${cert?.certificate_name}"? This action cannot be undone.`)) return;
            
            TrueVault.Toast.info('Revoking certificate...');
            
            const result = await TrueVault.API.post('/certificates/index.php', {
                action: 'revoke',
                id: id
            });
            
            if (result.success) {
                TrueVault.Toast.success('Certificate revoked');
                loadCertificates();
            } else {
                TrueVault.Toast.error(result.error || 'Failed to revoke certificate');
            }
        }
        
        async function backupCA() {
            TrueVault.Toast.info('Preparing CA backup...');
            
            const result = await TrueVault.API.get('/certificates/index.php?action=backup_ca');
            
            if (result.success && result.data.backup_data) {
                const blob = new Blob([JSON.stringify(result.data.backup_data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `truevault_ca_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                TrueVault.Toast.success('CA backup downloaded! Store this file securely.');
            } else {
                TrueVault.Toast.error(result.error || 'Failed to create backup');
            }
        }
        
        async function exportCAPublicKey() {
            TrueVault.Toast.info('Exporting public key...');
            
            const result = await TrueVault.API.get('/certificates/index.php?action=export_public');
            
            if (result.success && result.data.public_key) {
                const blob = new Blob([result.data.public_key], { type: 'application/x-pem-file' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'truevault_ca_public.pem';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                TrueVault.Toast.success('Public key exported!');
            } else {
                TrueVault.Toast.error(result.error || 'Failed to export public key');
            }
        }
        
        // Modal click outside to close
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) hideModal(this.id);
            });
        });
        
        // Load on page ready
        loadCertificates();
    </script>
</body>
</html>
