<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificates - TrueVault VPN</title>
    <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style id="theme-variables">:root{--colors-primary:#00d9ff;--colors-secondary:#00ff88;--colors-accent:#ff6b6b;--colors-background:#0f0f1a;--colors-background-secondary:#1a1a2e;--colors-text:#ffffff;--colors-text-muted:#888888;--colors-success:#00ff88;--colors-warning:#ffbb00;--colors-error:#ff5050;--gradients-primary:linear-gradient(90deg,#00d9ff,#00ff88);--gradients-background:linear-gradient(135deg,#0f0f1a,#1a1a2e);--buttons-border-radius:8px;--cards-border-radius:14px;--colors-border:rgba(255,255,255,0.08);--layout-sidebar-width:260px;}</style>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/dashboard.css">
    <style>
        .ca-card{background:linear-gradient(135deg,rgba(0,217,255,0.1),rgba(0,255,136,0.1));border:1px solid rgba(0,217,255,0.3);border-radius:var(--cards-border-radius);padding:30px;margin-bottom:30px}
        .ca-card.no-ca{border-color:var(--colors-warning);background:rgba(255,187,0,0.1)}
        .ca-header{display:flex;align-items:center;gap:20px;margin-bottom:20px}
        .ca-icon{font-size:3rem}
        .ca-info h2{font-size:1.5rem;margin-bottom:5px}
        .ca-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px}
        .ca-detail{background:rgba(0,0,0,0.2);padding:15px;border-radius:10px}
        .ca-detail-label{font-size:0.8rem;color:var(--colors-text-muted);margin-bottom:5px}
        .ca-detail-value{font-size:1rem;font-family:monospace}
        .certs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
        .cert-card{background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:var(--cards-border-radius);padding:20px}
        .cert-card.expiring{border-color:var(--colors-warning)}
        .cert-card.expired{border-color:var(--colors-error)}
        .cert-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:15px}
        .cert-type{padding:4px 10px;border-radius:15px;font-size:0.75rem;font-weight:600}
        .cert-type.root{background:rgba(0,217,255,0.2);color:var(--colors-primary)}
        .cert-type.device{background:rgba(0,255,136,0.2);color:var(--colors-secondary)}
        .cert-type.regional{background:rgba(255,187,0,0.2);color:var(--colors-warning)}
        .cert-type.mesh{background:rgba(138,43,226,0.2);color:#9b59b6}
        .cert-name{font-size:1.1rem;font-weight:600;margin-bottom:5px}
        .cert-serial{font-family:monospace;font-size:0.8rem;color:var(--colors-text-muted)}
        .cert-dates{display:flex;gap:20px;margin:15px 0;padding:15px 0;border-top:1px solid var(--colors-border);border-bottom:1px solid var(--colors-border)}
        .cert-date{flex:1}
        .cert-date-label{font-size:0.75rem;color:var(--colors-text-muted)}
        .cert-date-value{font-size:0.9rem;margin-top:3px}
        .cert-actions{display:flex;gap:8px}
        .generate-section{margin-top:30px}
        .generate-options{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px;margin-top:20px}
        .generate-option{background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s}
        .generate-option:hover{border-color:var(--colors-primary);background:rgba(255,255,255,0.05)}
        .generate-option .icon{font-size:2rem;margin-bottom:10px}
        .generate-option h4{margin-bottom:5px}
        .generate-option p{font-size:0.8rem;color:var(--colors-text-muted)}
        .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s}
        .modal.active{opacity:1;visibility:visible}
        .modal-content{background:var(--colors-background-secondary);border:1px solid var(--colors-border);border-radius:var(--cards-border-radius);padding:30px;width:100%;max-width:500px}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px}
        .modal-close{background:none;border:none;color:var(--colors-text-muted);font-size:1.5rem;cursor:pointer}
    </style>
</head>
<body class="dashboard-body">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><span class="logo-icon">ğŸ›¡ï¸</span><h1>TrueVault</h1></div>
        <nav class="sidebar-nav">
            <a href="/dashboard/" class="nav-item"><span class="nav-icon">ğŸ“Š</span><span>Overview</span></a>
            <a href="/dashboard/connect.html" class="nav-item"><span class="nav-icon">ğŸ”Œ</span><span>Connect</span></a>
            <a href="/dashboard/servers.html" class="nav-item"><span class="nav-icon">ğŸŒ</span><span>Servers</span></a>
            <a href="/dashboard/identities.html" class="nav-item"><span class="nav-icon">ğŸ­</span><span>Identities</span></a>
            <a href="/dashboard/certificates.html" class="nav-item active"><span class="nav-icon">ğŸ“œ</span><span>Certificates</span></a>
            <a href="/dashboard/devices.html" class="nav-item"><span class="nav-icon">ğŸ“±</span><span>Devices</span></a>
            <a href="/dashboard/cameras.html" class="nav-item"><span class="nav-icon">ğŸ“·</span><span>Cameras</span></a>
            <a href="/dashboard/mesh.html" class="nav-item"><span class="nav-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span><span>Mesh Network</span></a>
            <div class="nav-divider"></div>
            <a href="/dashboard/scanner.html" class="nav-item"><span class="nav-icon">ğŸ”</span><span>Network Scanner</span></a>
            <a href="/dashboard/settings.html" class="nav-item"><span class="nav-icon">âš™ï¸</span><span>Settings</span></a>
            <a href="/dashboard/billing.html" class="nav-item"><span class="nav-icon">ğŸ’³</span><span>Billing</span></a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info"><div class="user-avatar">ğŸ‘¤</div><div class="user-details"><span class="user-name" id="userName">Loading...</span><span class="user-plan" id="userPlan">-</span></div></div>
            <button class="btn btn-secondary btn-small" onclick="TrueVault.Auth.logout()">Logout</button>
        </div>
    </aside>
    
    <main class="main-content">
        <header class="dashboard-header">
            <div>
                <h1>ğŸ“œ Certificates</h1>
                <p class="text-muted">Your personal certificate authority and issued certificates</p>
            </div>
        </header>
        
        <!-- CA Status Card -->
        <div class="ca-card" id="caCard">
            <div class="ca-header">
                <span class="ca-icon" id="caIcon">ğŸ”</span>
                <div class="ca-info">
                    <h2 id="caTitle">Loading...</h2>
                    <p class="text-muted" id="caSubtitle">Checking your certificate authority...</p>
                </div>
            </div>
            <div class="ca-details" id="caDetails"></div>
            <div id="caActions" style="margin-top:20px"></div>
        </div>
        
        <!-- Certificates Grid -->
        <h3 style="margin-bottom:20px">ğŸ“‹ Your Certificates</h3>
        <div class="certs-grid" id="certsGrid">
            <div class="loading">Loading certificates...</div>
        </div>
        
        <!-- Generate New Certificate -->
        <div class="generate-section">
            <h3>â• Generate New Certificate</h3>
            <div class="generate-options">
                <div class="generate-option" onclick="showGenerateModal('device')">
                    <div class="icon">ğŸ“±</div>
                    <h4>Device Certificate</h4>
                    <p>Secure a new device</p>
                </div>
                <div class="generate-option" onclick="showGenerateModal('regional')">
                    <div class="icon">ğŸŒ</div>
                    <h4>Regional Identity</h4>
                    <p>Create regional persona</p>
                </div>
                <div class="generate-option" onclick="showGenerateModal('mesh')">
                    <div class="icon">ğŸ”—</div>
                    <h4>Mesh Certificate</h4>
                    <p>For family mesh network</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Generate Certificate Modal -->
    <div class="modal" id="generateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Generate Certificate</h2>
                <button class="modal-close" onclick="hideModal()">&times;</button>
            </div>
            <form id="generateForm">
                <input type="hidden" name="type" id="certType">
                
                <div class="form-group">
                    <label>Certificate Name *</label>
                    <input type="text" name="name" id="certName" placeholder="e.g., My iPhone, US Banking, Family Network" required>
                </div>
                
                <div class="form-group" id="regionGroup" style="display:none">
                    <label>Region</label>
                    <select name="region_code" id="regionCode">
                        <option value="US">ğŸ‡ºğŸ‡¸ United States</option>
                        <option value="CA">ğŸ‡¨ğŸ‡¦ Canada</option>
                        <option value="UK">ğŸ‡¬ğŸ‡§ United Kingdom</option>
                        <option value="DE">ğŸ‡©ğŸ‡ª Germany</option>
                        <option value="FR">ğŸ‡«ğŸ‡· France</option>
                        <option value="AU">ğŸ‡¦ğŸ‡º Australia</option>
                        <option value="JP">ğŸ‡¯ğŸ‡µ Japan</option>
                    </select>
                </div>
                
                <div style="display:flex;gap:10px;margin-top:25px">
                    <button type="button" class="btn btn-secondary" onclick="hideModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex:1">ğŸ” Generate</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="/assets/js/theme-loader.js"></script>
    <script src="/assets/js/app.js"></script>
    <script>
        if (!TrueVault.Auth.requireAuth()) {}
        
        let certificates = [];
        let hasCA = false;
        
        const user = TrueVault.Auth.getUser();
        if (user) {
            document.getElementById('userName').textContent = user.first_name + ' ' + user.last_name;
            document.getElementById('userPlan').textContent = user.plan_type.charAt(0).toUpperCase() + user.plan_type.slice(1) + ' Plan';
        }
        
        async function loadCertificates() {
            const result = await TrueVault.API.get('/certificates/index.php');
            
            if (result.success) {
                hasCA = result.data.has_ca;
                certificates = result.data.certificates || [];
                
                renderCA(result.data.ca_info);
                renderCertificates();
            } else {
                document.getElementById('caCard').innerHTML = '<p class="text-error">Failed to load certificates</p>';
            }
        }
        
        function renderCA(caInfo) {
            const card = document.getElementById('caCard');
            const icon = document.getElementById('caIcon');
            const title = document.getElementById('caTitle');
            const subtitle = document.getElementById('caSubtitle');
            const details = document.getElementById('caDetails');
            const actions = document.getElementById('caActions');
            
            if (hasCA && caInfo) {
                card.classList.remove('no-ca');
                icon.textContent = 'ğŸ”';
                title.textContent = 'Your Personal CA';
                subtitle.textContent = 'Your cryptographic identity is active and secure';
                
                details.innerHTML = `
                    <div class="ca-detail">
                        <div class="ca-detail-label">Serial Number</div>
                        <div class="ca-detail-value">${caInfo.serial_number}</div>
                    </div>
                    <div class="ca-detail">
                        <div class="ca-detail-label">Created</div>
                        <div class="ca-detail-value">${formatDate(caInfo.created_at)}</div>
                    </div>
                    <div class="ca-detail">
                        <div class="ca-detail-label">Expires</div>
                        <div class="ca-detail-value">${formatDate(caInfo.expires_at)}</div>
                    </div>
                    <div class="ca-detail">
                        <div class="ca-detail-label">Certificates Issued</div>
                        <div class="ca-detail-value">${certificates.length}</div>
                    </div>
                `;
                
                actions.innerHTML = `
                    <button class="btn btn-secondary" onclick="backupCA()">ğŸ“¥ Backup CA</button>
                `;
            } else {
                card.classList.add('no-ca');
                icon.textContent = 'âš ï¸';
                title.textContent = 'No Certificate Authority';
                subtitle.textContent = 'Create your personal CA to start issuing certificates';
                details.innerHTML = '';
                actions.innerHTML = `
                    <button class="btn btn-primary btn-large" onclick="createCA()">ğŸ” Create Your Certificate Authority</button>
                `;
            }
        }
        
        function renderCertificates() {
            const grid = document.getElementById('certsGrid');
            
            if (!hasCA) {
                grid.innerHTML = '<p class="text-muted">Create a Certificate Authority first to start issuing certificates.</p>';
                return;
            }
            
            if (certificates.length === 0) {
                grid.innerHTML = '<p class="text-muted">No certificates issued yet. Generate your first certificate below.</p>';
                return;
            }
            
            grid.innerHTML = certificates.map(cert => {
                const status = getCertStatus(cert);
                return `
                    <div class="cert-card ${status.class}">
                        <div class="cert-header">
                            <span class="cert-type ${cert.certificate_type}">${cert.certificate_type}</span>
                            <span class="badge badge-${status.badge}">${status.text}</span>
                        </div>
                        <div class="cert-name">${cert.certificate_name}</div>
                        <div class="cert-serial">Serial: ${cert.serial_number}</div>
                        <div class="cert-dates">
                            <div class="cert-date">
                                <div class="cert-date-label">Issued</div>
                                <div class="cert-date-value">${formatDate(cert.issued_at)}</div>
                            </div>
                            <div class="cert-date">
                                <div class="cert-date-label">Expires</div>
                                <div class="cert-date-value">${formatDate(cert.expires_at)}</div>
                            </div>
                        </div>
                        <div class="cert-actions">
                            <button class="btn btn-secondary btn-small" onclick="downloadCert(${cert.id})">ğŸ“¥ Download</button>
                            <button class="btn btn-secondary btn-small" onclick="viewCert(${cert.id})">ğŸ‘ï¸ View</button>
                            <button class="btn btn-danger btn-small" onclick="revokeCert(${cert.id})">ğŸ—‘ï¸ Revoke</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getCertStatus(cert) {
            const now = new Date();
            const expires = new Date(cert.expires_at);
            const daysLeft = Math.ceil((expires - now) / (1000 * 60 * 60 * 24));
            
            if (cert.status === 'revoked') return { text: 'Revoked', badge: 'error', class: 'expired' };
            if (daysLeft < 0) return { text: 'Expired', badge: 'error', class: 'expired' };
            if (daysLeft < 30) return { text: `${daysLeft}d left`, badge: 'warning', class: 'expiring' };
            return { text: 'Valid', badge: 'success', class: '' };
        }
        
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        async function createCA() {
            if (!confirm('Create your Personal Certificate Authority? This is a one-time action.')) return;
            
            TrueVault.Toast.info('Creating your Certificate Authority...');
            
            const result = await TrueVault.API.post('/certificates/index.php', { type: 'root', name: 'Personal Root CA' });
            
            if (result.success) {
                TrueVault.Toast.success('Certificate Authority created!');
                loadCertificates();
            } else {
                TrueVault.Toast.error(result.error || 'Failed to create CA');
            }
        }
        
        function showGenerateModal(type) {
            if (!hasCA) {
                TrueVault.Toast.error('Create a Certificate Authority first');
                return;
            }
            
            document.getElementById('certType').value = type;
            document.getElementById('certName').value = '';
            
            const titles = { device: 'ğŸ“± Device Certificate', regional: 'ğŸŒ Regional Identity', mesh: 'ğŸ”— Mesh Certificate' };
            document.getElementById('modalTitle').textContent = titles[type] || 'Generate Certificate';
            
            document.getElementById('regionGroup').style.display = type === 'regional' ? 'block' : 'none';
            
            document.getElementById('generateModal').classList.add('active');
        }
        
        function hideModal() {
            document.getElementById('generateModal').classList.remove('active');
        }
        
        document.getElementById('generateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = TrueVault.Form.serialize(this);
            TrueVault.Toast.info('Generating certificate...');
            
            const result = await TrueVault.API.post('/certificates/index.php', data);
            
            if (result.success) {
                TrueVault.Toast.success('Certificate generated!');
                hideModal();
                loadCertificates();
            } else {
                TrueVault.Toast.error(result.error || 'Failed to generate certificate');
            }
        });
        
        function downloadCert(id) {
            TrueVault.Toast.info('Preparing download...');
            // In production: API call to get certificate file
        }
        
        function viewCert(id) {
            TrueVault.Toast.info('Certificate details coming soon');
        }
        
        async function revokeCert(id) {
            if (!confirm('Revoke this certificate? This cannot be undone.')) return;
            TrueVault.Toast.success('Certificate revoked');
            loadCertificates();
        }
        
        function backupCA() {
            TrueVault.Toast.info('Backup feature coming soon');
        }
        
        document.getElementById('generateModal').addEventListener('click', function(e) {
            if (e.target === this) hideModal();
        });
        
        loadCertificates();
    </script>
</body>
</html>
