<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect - TrueVault VPN</title>
    <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style id="theme-variables">:root{--colors-primary:#00d9ff;--colors-secondary:#00ff88;--colors-accent:#ff6b6b;--colors-background:#0f0f1a;--colors-background-secondary:#1a1a2e;--colors-text:#ffffff;--colors-text-muted:#888888;--colors-success:#00ff88;--colors-warning:#ffbb00;--colors-error:#ff5050;--gradients-primary:linear-gradient(90deg,#00d9ff,#00ff88);--gradients-background:linear-gradient(135deg,#0f0f1a,#1a1a2e);--buttons-border-radius:8px;--cards-border-radius:14px;--colors-border:rgba(255,255,255,0.08);--layout-sidebar-width:260px;}</style>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/dashboard.css">
    <style>
        .connect-container{max-width:600px;margin:0 auto}
        .connect-card{background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:var(--cards-border-radius);padding:40px;text-align:center}
        .connect-card.connected{border-color:var(--colors-success);background:rgba(0,255,136,0.05)}
        .connect-icon{font-size:5rem;margin-bottom:20px}
        .connect-status{font-size:1.5rem;font-weight:600;margin-bottom:10px}
        .connect-status.connected{color:var(--colors-success)}
        .connect-status.disconnected{color:var(--colors-error)}
        .connect-details{color:var(--colors-text-muted);margin-bottom:30px}
        .connect-btn{padding:15px 50px;font-size:1.2rem}
        .connection-info{background:rgba(0,0,0,0.2);border-radius:12px;padding:20px;margin-top:30px;text-align:left}
        .connection-info h4{margin-bottom:15px;font-size:1rem}
        .info-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--colors-border)}
        .info-row:last-child{border-bottom:none}
        .info-label{color:var(--colors-text-muted)}
        .info-value{font-family:monospace;color:var(--colors-primary)}
        .quick-servers{margin-top:30px}
        .quick-servers h4{margin-bottom:15px;text-align:left}
        .quick-server-list{display:flex;flex-direction:column;gap:10px}
        .quick-server{display:flex;align-items:center;justify-content:space-between;padding:12px 15px;background:rgba(255,255,255,0.03);border:1px solid var(--colors-border);border-radius:8px;cursor:pointer;transition:all 0.2s}
        .quick-server:hover{border-color:var(--colors-primary);background:rgba(255,255,255,0.05)}
        .quick-server-info{display:flex;align-items:center;gap:12px}
        .quick-server-flag{font-size:1.5rem}
        .quick-server-name{font-weight:500}
        .quick-server-load{font-size:0.85rem;color:var(--colors-text-muted)}
        .stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-top:30px}
        .stat-item{text-align:center;padding:15px;background:rgba(255,255,255,0.02);border-radius:10px}
        .stat-item .value{font-size:1.5rem;font-weight:600;background:var(--gradients-primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .stat-item .label{font-size:0.8rem;color:var(--colors-text-muted);margin-top:5px}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
        .connecting .connect-icon{animation:pulse 1s infinite}
    </style>
</head>
<body class="dashboard-body">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><span class="logo-icon">ğŸ›¡ï¸</span><h1>TrueVault</h1></div>
        <nav class="sidebar-nav">
            <a href="/dashboard/" class="nav-item"><span class="nav-icon">ğŸ“Š</span><span>Overview</span></a>
            <a href="/dashboard/connect.html" class="nav-item active"><span class="nav-icon">ğŸ”Œ</span><span>Connect</span></a>
            <a href="/dashboard/servers.html" class="nav-item"><span class="nav-icon">ğŸŒ</span><span>Servers</span></a>
            <a href="/dashboard/identities.html" class="nav-item"><span class="nav-icon">ğŸ­</span><span>Identities</span></a>
            <a href="/dashboard/certificates.html" class="nav-item"><span class="nav-icon">ğŸ“œ</span><span>Certificates</span></a>
            <a href="/dashboard/devices.html" class="nav-item"><span class="nav-icon">ğŸ“±</span><span>Devices</span></a>
            <a href="/dashboard/cameras.html" class="nav-item"><span class="nav-icon">ğŸ“·</span><span>Cameras</span></a>
            <a href="/dashboard/mesh.html" class="nav-item"><span class="nav-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span><span>Mesh Network</span></a>
            <div class="nav-divider"></div>
            <a href="/dashboard/scanner.html" class="nav-item"><span class="nav-icon">ğŸ”</span><span>Network Scanner</span></a>
            <a href="/dashboard/settings.html" class="nav-item"><span class="nav-icon">âš™ï¸</span><span>Settings</span></a>
            <a href="/dashboard/billing.html" class="nav-item"><span class="nav-icon">ğŸ’³</span><span>Billing</span></a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info"><div class="user-avatar">ğŸ‘¤</div><div class="user-details"><span class="user-name" id="userName">Loading...</span><span class="user-plan" id="userPlan">-</span></div></div>
            <button class="btn btn-secondary btn-small" onclick="TrueVault.Auth.logout()">Logout</button>
        </div>
    </aside>
    
    <main class="main-content">
        <header class="dashboard-header">
            <div>
                <h1>ğŸ”Œ Quick Connect</h1>
                <p class="text-muted">One-click connection to optimal server</p>
            </div>
        </header>
        
        <div class="connect-container">
            <!-- Main Connect Card -->
            <div class="connect-card" id="connectCard">
                <div class="connect-icon" id="connectIcon">ğŸ”’</div>
                <div class="connect-status disconnected" id="connectStatus">Disconnected</div>
                <div class="connect-details" id="connectDetails">Your connection is not protected</div>
                <button class="btn btn-primary connect-btn" id="connectBtn" onclick="toggleConnection()">
                    ğŸš€ Connect Now
                </button>
                
                <!-- Connection Info (shown when connected) -->
                <div class="connection-info" id="connectionInfo" style="display:none">
                    <h4>ğŸ” Connection Details</h4>
                    <div class="info-row">
                        <span class="info-label">Server</span>
                        <span class="info-value" id="infoServer">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Your VPN IP</span>
                        <span class="info-value" id="infoIp">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Protocol</span>
                        <span class="info-value" id="infoProtocol">WireGuard</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Duration</span>
                        <span class="info-value" id="infoDuration">-</span>
                    </div>
                </div>
            </div>
            
            <!-- Usage Stats -->
            <div class="stats-row">
                <div class="stat-item">
                    <div class="value" id="statData">0 MB</div>
                    <div class="label">Data Today</div>
                </div>
                <div class="stat-item">
                    <div class="value" id="statTime">0h 0m</div>
                    <div class="label">Time Today</div>
                </div>
                <div class="stat-item">
                    <div class="value" id="statConnections">0</div>
                    <div class="label">Connections</div>
                </div>
            </div>
            
            <!-- Quick Server Selection -->
            <div class="quick-servers">
                <h4>âš¡ Quick Select Server</h4>
                <div class="quick-server-list" id="quickServers">
                    <div class="loading">Loading servers...</div>
                </div>
            </div>
        </div>
    </main>
    
    <script src="/assets/js/theme-loader.js"></script>
    <script src="/assets/js/app.js"></script>
    <script>
        if (!TrueVault.Auth.requireAuth()) {}
        
        let isConnected = false;
        let currentConnection = null;
        let servers = [];
        let durationInterval = null;
        
        const user = TrueVault.Auth.getUser();
        if (user) {
            document.getElementById('userName').textContent = user.first_name + ' ' + user.last_name;
            document.getElementById('userPlan').textContent = user.plan_type.charAt(0).toUpperCase() + user.plan_type.slice(1) + ' Plan';
        }
        
        async function loadData() {
            // Load connection status
            const status = await TrueVault.API.get('/vpn/status.php');
            if (status.success) {
                if (status.data.is_connected && status.data.connections.length > 0) {
                    currentConnection = status.data.connections[0];
                    setConnectedState();
                }
                updateUsageStats(status.data.usage);
            }
            
            // Load servers
            const serversResult = await TrueVault.API.get('/vpn/servers.php');
            if (serversResult.success) {
                servers = serversResult.data.servers;
                renderQuickServers();
            }
        }
        
        function renderQuickServers() {
            const container = document.getElementById('quickServers');
            const topServers = servers.filter(s => s.status === 'active').slice(0, 4);
            
            const flags = {
                'US': 'ğŸ‡ºğŸ‡¸', 'CA': 'ğŸ‡¨ğŸ‡¦', 'UK': 'ğŸ‡¬ğŸ‡§', 'GB': 'ğŸ‡¬ğŸ‡§',
                'DE': 'ğŸ‡©ğŸ‡ª', 'FR': 'ğŸ‡«ğŸ‡·', 'AU': 'ğŸ‡¦ğŸ‡º', 'JP': 'ğŸ‡¯ğŸ‡µ', 'SG': 'ğŸ‡¸ğŸ‡¬'
            };
            
            container.innerHTML = topServers.map(s => `
                <div class="quick-server" onclick="connectToServer(${s.id})">
                    <div class="quick-server-info">
                        <span class="quick-server-flag">${flags[s.country] || 'ğŸŒ'}</span>
                        <div>
                            <div class="quick-server-name">${s.server_name}</div>
                            <div class="quick-server-load">${s.load_percent}% load â€¢ ${s.current_connections} users</div>
                        </div>
                    </div>
                    <span class="badge badge-${s.status === 'active' ? 'success' : 'error'}">${s.load_percent}%</span>
                </div>
            `).join('');
        }
        
        function updateUsageStats(usage) {
            if (usage && usage.today) {
                const totalBytes = usage.today.bytes_sent + usage.today.bytes_received;
                document.getElementById('statData').textContent = TrueVault.Utils.formatBytes(totalBytes);
                document.getElementById('statTime').textContent = TrueVault.Utils.formatDuration(usage.today.duration_seconds);
                document.getElementById('statConnections').textContent = usage.today.connection_count;
            }
        }
        
        function setConnectedState() {
            isConnected = true;
            const card = document.getElementById('connectCard');
            const icon = document.getElementById('connectIcon');
            const status = document.getElementById('connectStatus');
            const details = document.getElementById('connectDetails');
            const btn = document.getElementById('connectBtn');
            const info = document.getElementById('connectionInfo');
            
            card.classList.add('connected');
            card.classList.remove('connecting');
            icon.textContent = 'ğŸ”“';
            status.textContent = 'Protected';
            status.className = 'connect-status connected';
            details.textContent = `Connected to ${currentConnection.server.name}`;
            btn.textContent = 'ğŸ”Œ Disconnect';
            btn.className = 'btn btn-danger connect-btn';
            info.style.display = 'block';
            
            document.getElementById('infoServer').textContent = currentConnection.server.name;
            document.getElementById('infoIp').textContent = currentConnection.assigned_ip;
            
            // Start duration counter
            startDurationCounter();
        }
        
        function setDisconnectedState() {
            isConnected = false;
            currentConnection = null;
            const card = document.getElementById('connectCard');
            const icon = document.getElementById('connectIcon');
            const status = document.getElementById('connectStatus');
            const details = document.getElementById('connectDetails');
            const btn = document.getElementById('connectBtn');
            const info = document.getElementById('connectionInfo');
            
            card.classList.remove('connected', 'connecting');
            icon.textContent = 'ğŸ”’';
            status.textContent = 'Disconnected';
            status.className = 'connect-status disconnected';
            details.textContent = 'Your connection is not protected';
            btn.textContent = 'ğŸš€ Connect Now';
            btn.className = 'btn btn-primary connect-btn';
            info.style.display = 'none';
            
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
        }
        
        function setConnectingState() {
            const card = document.getElementById('connectCard');
            const icon = document.getElementById('connectIcon');
            const status = document.getElementById('connectStatus');
            const details = document.getElementById('connectDetails');
            const btn = document.getElementById('connectBtn');
            
            card.classList.add('connecting');
            icon.textContent = 'â³';
            status.textContent = 'Connecting...';
            status.className = 'connect-status';
            details.textContent = 'Establishing secure connection';
            btn.disabled = true;
            btn.textContent = 'â³ Connecting...';
        }
        
        function startDurationCounter() {
            if (durationInterval) clearInterval(durationInterval);
            
            const startTime = new Date(currentConnection.connected_at);
            
            durationInterval = setInterval(() => {
                const now = new Date();
                const seconds = Math.floor((now - startTime) / 1000);
                document.getElementById('infoDuration').textContent = TrueVault.Utils.formatDuration(seconds);
            }, 1000);
        }
        
        async function toggleConnection() {
            if (isConnected) {
                await disconnect();
            } else {
                await quickConnect();
            }
        }
        
        async function quickConnect() {
            setConnectingState();
            
            // Get best server (first available)
            const bestServer = servers.find(s => s.status === 'active');
            if (!bestServer) {
                TrueVault.Toast.error('No servers available');
                setDisconnectedState();
                return;
            }
            
            const result = await TrueVault.API.post('/vpn/connect.php', { server_id: bestServer.id });
            
            if (result.success) {
                currentConnection = {
                    server: bestServer,
                    assigned_ip: result.data.assigned_ip,
                    connected_at: new Date().toISOString()
                };
                setConnectedState();
                TrueVault.Toast.success(`Connected to ${bestServer.server_name}!`);
            } else {
                TrueVault.Toast.error(result.error || 'Connection failed');
                setDisconnectedState();
            }
            
            document.getElementById('connectBtn').disabled = false;
        }
        
        async function connectToServer(serverId) {
            setConnectingState();
            
            const server = servers.find(s => s.id === serverId);
            const result = await TrueVault.API.post('/vpn/connect.php', { server_id: serverId });
            
            if (result.success) {
                currentConnection = {
                    server: server,
                    assigned_ip: result.data.assigned_ip,
                    connected_at: new Date().toISOString()
                };
                setConnectedState();
                TrueVault.Toast.success(`Connected to ${server.server_name}!`);
            } else {
                TrueVault.Toast.error(result.error || 'Connection failed');
                setDisconnectedState();
            }
            
            document.getElementById('connectBtn').disabled = false;
        }
        
        async function disconnect() {
            document.getElementById('connectBtn').disabled = true;
            
            const result = await TrueVault.API.post('/vpn/disconnect.php', {});
            
            if (result.success) {
                setDisconnectedState();
                TrueVault.Toast.success('Disconnected');
            } else {
                TrueVault.Toast.error(result.error || 'Failed to disconnect');
            }
            
            document.getElementById('connectBtn').disabled = false;
        }
        
        loadData();
    </script>
</body>
</html>
