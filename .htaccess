# TrueVault VPN - Main .htaccess
# Routes requests to public directory and API

RewriteEngine On

# Force HTTPS (uncomment in production)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# API requests go to api directory
RewriteCond %{REQUEST_URI} ^/api/
RewriteRule ^api/(.*)$ api/$1 [L]

# Static assets
RewriteCond %{REQUEST_URI} ^/assets/
RewriteRule ^assets/(.*)$ public/assets/$1 [L]

# Dashboard routes
RewriteCond %{REQUEST_URI} ^/dashboard
RewriteRule ^dashboard/?$ public/dashboard/index.html [L]
RewriteRule ^dashboard/(.*)$ public/dashboard/$1 [L]

# Admin routes
RewriteCond %{REQUEST_URI} ^/admin
RewriteRule ^admin/?$ public/admin/index.html [L]
RewriteRule ^admin/(.*)$ public/admin/$1 [L]

# Public pages
RewriteRule ^login/?$ public/login.html [L]
RewriteRule ^register/?$ public/register.html [L]

# Serve existing files directly from public
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{DOCUMENT_ROOT}/public%{REQUEST_URI} -f
RewriteRule ^(.*)$ public/$1 [L]

# Default to public/index.html
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^$ public/index.html [L]

# Security - Prevent access to sensitive files
<FilesMatch "^(\.env|\.git|composer\.|chat_log)">
    Order allow,deny
    Deny from all
</FilesMatch>

# Prevent directory listing
Options -Indexes

# CORS headers for fonts and assets
<IfModule mod_headers.c>
    <FilesMatch "\.(ttf|ttc|otf|eot|woff|woff2|font.css|css|js)$">
        Header set Access-Control-Allow-Origin "*"
    </FilesMatch>
</IfModule>

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/css application/json application/javascript text/javascript application/x-javascript
</IfModule>

# Caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
</IfModule>
